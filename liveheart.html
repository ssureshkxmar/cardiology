<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>‚ù§Ô∏è Adaptive Cardiology Care - AI Analysis System</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- Favicon fix -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ù§Ô∏è</text></svg>">

<style>
* { margin:0; padding:0; box-sizing:border-box; }
html, body { 
  min-height:100%; 
  background:#000; 
  font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; 
  color:#fff; 
  overflow-x: hidden;
  overflow-y: auto;
}

/* ================= GOVERNMENT HEADER ================= */
.gov-topbar {
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-bottom: 1px solid rgba(255,255,255,0.12);
    padding: 10px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1200;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
}

.gov-topbar-left {
    display: flex;
    align-items: center;
    gap: 14px;
}

.gov-emblem {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    background: #000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2px;
    position: relative;
    overflow: hidden;
}

.gov-emblem img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    filter: brightness(1.1) contrast(1.2) drop-shadow(0 0 10px rgba(218, 165, 32, 0.6));
    mix-blend-mode: screen;
}

.gov-topbar-text {
    display: flex;
    flex-direction: column;
}

.gov-topbar-text span:first-child {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: rgba(255,255,255,0.5);
    font-weight: 600;
}

.gov-topbar-text span:last-child {
    font-size: 1rem;
    font-weight: 700;
    background: linear-gradient(135deg, #00d4ff, #0099ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.gov-topbar-right {
    font-size: 0.85rem;
    color: rgba(255,255,255,0.7);
    font-weight: 500;
}

/* ================= BACK BUTTON HEADER ================= */
.app-header {
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-bottom: 1px solid rgba(255,255,255,0.12);
    padding: 12px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: fixed;
    top: 70px;
    left: 0;
    right: 0;
    z-index: 1100;
    overflow: hidden;
}

.app-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: linear-gradient(90deg, rgba(0, 212, 255, 0.05) 0%, transparent 50%, rgba(6, 255, 165, 0.05) 100%);
    pointer-events: none;
}

.app-header-left {
    display: flex;
    align-items: center;
    gap: 16px;
    position: relative;
    z-index: 1;
}

.back-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    color: rgba(255,255,255,0.95);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
}

.back-button:hover {
    background: rgba(255,255,255,0.08);
    transform: translateX(-4px);
    border-color: rgba(0, 212, 255, 0.5);
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
}

.app-header-content {
    display: flex;
    flex-direction: column;
}

.app-title {
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: -0.01em;
    background: linear-gradient(135deg, #fff 0%, #00d4ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.app-subtitle {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.7);
    margin-top: 2px;
}

.app-header-right {
    display: flex;
    gap: 10px;
    align-items: center;
}

* { margin:0; padding:0; box-sizing:border-box; }


/* Dynamic themes */
:root {
  --bg: #000;
  --text: #fff;
  --muted: rgba(255,255,255,0.7);
  --panel: rgba(255,255,255,0.05);
  --panel-2: rgba(255,255,255,0.03);
  --border: rgba(255,255,255,0.12);
  --glow-r: 255,43,43;
  --accent: #ff4f6b;
  --accent-2: #4aff4a;
  --blue: #6ec2ff;
  --gold: #ffd27a;
  --violet: #7c3aed;
  --brand-1: #ff2b2b;
  --brand-2: #ff6b6b;

  --grid-bright: 1.0;
  --ecg-intensity: 1.0;
  --resp-intensity: 1.0;

  /* Beacon states */
  --beacon-red: #ff2b2b;
  --beacon-yellow: #ffd700;
}
:root[data-theme="light"] {
  --bg: #f7f8fa;
  --text: #111;
  --muted: #4b5563;
  --panel: rgba(0,0,0,0.06);
  --panel-2: rgba(0,0,0,0.04);
  --border: rgba(0,0,0,0.12);
  --accent: #ef4444;
  --accent-2:#0ea5e9;
  --blue: #2563eb;
  --gold: #b45309;
  --violet: #6d28d9;
}

/* Header */
.old-header-removed {
  background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
  backdrop-filter: blur(30px) saturate(120%);
  padding: 12px 20px;
  display:grid; grid-template-columns: 1fr auto 1fr; align-items:center;
  border-bottom: 1px solid var(--border);
  position:fixed; top:0; left:0; right:0; z-index:100;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}
.logo {
  font-size:24px; font-weight:900;
  background: linear-gradient(135deg, var(--brand-1), var(--brand-2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  display:flex; align-items:center; gap:10px;
}
.logo::before {
  content: "‚ù§Ô∏è";
  font-size: 32px;
  -webkit-text-fill-color: initial;
  filter: drop-shadow(0 0 15px rgba(255,43,43,0.9));
  animation: heartbeat 1.6s ease-in-out infinite;
}
@keyframes heartbeat { 0%, 100% { transform: scale(1);} 25%{transform:scale(1.12);} 50%{transform:scale(1);} }
.menu-button {
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 14px; border-radius: 12px; cursor: pointer; font-size: 13px; font-weight: 700;
  transition: all 0.25s ease;
}
.menu-button:hover { background: rgba(255,255,255,0.12); transform: translateY(-2px); }
.theme-toggle {
  background: linear-gradient(90deg, rgba(59,130,246,0.12), rgba(147,51,234,0.12));
  color: var(--text); border:1px solid var(--border);
  padding:8px 10px; border-radius:12px; cursor:pointer; font-weight:900; font-size:12px;
  box-shadow: 0 8px 24px rgba(124,58,237,0.18);
}

/* Center clock */
.header-clock {
  justify-self: center;
  font-weight:900;
  font-size: 16px;
  color: #fff;
  letter-spacing: 0.6px;
  background: linear-gradient(90deg, rgba(74,222,128,0.22), rgba(59,130,246,0.22));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 14px rgba(124,58,237,0.18);
  user-select: none;
}

/* Header right ‚Äî replaced dots with single HR beacon */
.header-right { justify-self: end; display:flex; align-items:center; gap:10px; }
#hrBeacon {
  width:28px; height:28px; border-radius:50%;
  border:1px solid var(--border);
  box-shadow: 0 0 8px rgba(255,255,255,0.18), inset 0 0 8px rgba(255,255,255,0.08);
  animation: beaconPulse 1.2s ease-in-out infinite;
}
/* Default color (yellow) */
#hrBeacon.beacon-yellow { background: radial-gradient(circle at 50% 40%, var(--beacon-yellow) 40%, #161405 70%); }
/* High tachy (red) */
#hrBeacon.beacon-red { background: radial-gradient(circle at 50% 40%, var(--beacon-red) 40%, #190505 70%); }
@keyframes beaconPulse {
  0% { transform: scale(1); filter: drop-shadow(0 0 6px rgba(255,255,255,0.18)); }
  50% { transform: scale(1.15); filter: drop-shadow(0 0 20px rgba(255,255,255,0.35)); }
  100% { transform: scale(1); filter: drop-shadow(0 0 6px rgba(255,255,255,0.18)); }
}

/* Layout */
.main-content {
  margin-top: 140px; padding: 15px; margin-bottom: 40px; display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 300px;
  overflow:hidden; gap: 15px;
  min-height: calc(100vh - 160px);
}
.card {
  background: var(--panel-2);
  backdrop-filter: blur(30px) saturate(130%);
  border-radius: 20px;
  border: 1px solid var(--border);
  padding: 15px; display:flex; flex-direction:column;
  box-shadow: 0 8px 32px rgba(255,43,43,0.12);
}
.heart-section { grid-column: 1; grid-row: 1 / 3; }
.ecg-section { grid-column: 2; grid-row: 1; }
.patient-section { grid-column: 2; grid-row: 2; overflow:auto; height: 300px; display:flex; align-items:center; padding:8px; }
.patient-section::-webkit-scrollbar { width:6px; }
.patient-section::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.18); border-radius:10px; }
@media (max-width: 1000px){
  .main-content { grid-template-columns: 1fr; grid-template-rows: auto auto auto; height:auto; }
  .heart-section { grid-row: 1;}
  .ecg-section { grid-row: 2;}
  .patient-section { grid-row: 3; max-height: 320px; }
}

.section-title { font-size:16px; font-weight:900; margin-bottom:10px; color:var(--text); }

/* Monitor */
.monitor { display:flex; gap:12px; align-items:stretch; height:100%; }
.monitor-screen { flex: 1 1 auto; position:relative; background:#000; border-radius:12px; overflow:hidden; box-shadow: inset 0 0 60px rgba(0,255,120,0.04); }
.monitor-canvas { width:100%; height:100%; display:block }
.monitor-leftbar { width:360px; background:linear-gradient(180deg,#020202,#050505); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:12px; }
.monitor-header { display:flex; justify-content:space-between; align-items:center; padding:8px 10px; gap:10px }
.alarm-box { background:#0b0b0b; border:2px solid rgba(255,0,0,0.18); color:#ff7474; padding:8px 10px; border-radius:10px; font-weight:900 }
.monitor-buttons { display:flex; gap:8px; flex-wrap:wrap;}
.monitor-btn { background:rgba(255,255,255,0.06); border:1px solid var(--border); padding:9px 12px; border-radius:10px; color: var(--text); font-weight:800; cursor:pointer; font-size:12px; letter-spacing:0.2px; transition:all .2s; }
.monitor-btn:hover { background:rgba(255,255,255,0.12); transform: translateY(-1px); }
.vital-item { display:flex; flex-direction:column; align-items:flex-start; gap:6px; padding:10px; border-radius:10px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08) }
.small-blue { color:var(--blue); font-weight:900; font-size:20px; text-shadow:0 0 10px rgba(110,194,255,0.15) }
.monitor-grid { position:absolute; inset:0; pointer-events:none }

/* Heart video */
#heartBox { flex: 1; position:relative; background: radial-gradient(ellipse at center, rgba(30,10,15,0.55) 0%, rgba(0,0,0,0.92) 100%); border-radius: 15px; overflow:hidden; min-height: 340px; }
@media (max-height: 900px) { .main-content { grid-template-rows: 1fr 260px; } #heartBox { min-height: 300px; } }
#heartBox video { width:100%; height:100%; display:block; object-fit:cover; background:#000; }
.video-overlay {
  position:absolute; top:10px; left:10px; display:flex; gap:8px; z-index:5;
}
.badge {
  font-size:11px; font-weight:900; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,0.12);
  background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
}
.badge.neon { color:#9bf; text-shadow:0 0 10px rgba(110,194,255,0.35); }
.badge.hr { color:#4aff4a; }

/* Embedded signals under monitor */
.monitor-signals { position:absolute; left:12px; right:12px; bottom:12px; z-index:31; display:flex; flex-direction:column; gap:10px; }
.signal-box { width:100%; background:rgba(255,255,255,0.04); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); }
.signal-title { font-size:12px; font-weight:900; margin-bottom:6px; text-align:left; color:#9bf; }
.signal-title.mech { color:#ff7b7b; }
#ekgSignal { width:100%; height:100px; border-radius:8px; background:rgba(0,0,0,0.65); border:1px solid rgba(255,255,255,0.08); }
#mechSignal { width:100%; height:90px; border-radius:8px; background:rgba(0,0,0,0.65); border:1px solid rgba(255,255,255,0.08); }

/* Bedside metrics */
.bedside-metrics { width:100%; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.bedside-row { display:flex; align-items:center; justify-content:space-between; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.12); border-radius:10px; padding:8px; }
.bedside-label { color:var(--muted); font-weight:800; font-size:12px; }
.bedside-value { color:var(--text); font-weight:900; font-size:13px; }

/* Patient panel */
.section-title-large { font-size:18px; font-weight:900; margin-bottom:10px; }
.patient-panel { width:100%; }
.patient-name { font-size:16px; color:var(--text); font-weight:900; letter-spacing:0.2px; }
.patient-updated { font-size:11px; color:var(--muted); margin-top:4px; }
.patient-symptoms { color:rgba(255,255,255,0.88); font-size:13px; text-align:right; max-width:420px; }
.patient-extra { display:none; }

/* Tooltips */
.tooltip { position:relative; cursor: help; }
.tooltip:hover::after {
  content: attr(data-tip);
  position:absolute; left:0; bottom:120%; background: rgba(0,0,0,0.85); color:#fff;
  padding:6px 8px; font-size:11px; border-radius:6px; white-space:nowrap; box-shadow: 0 6px 18px rgba(0,0,0,0.3);
}

/* Modal base */
.modal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background: rgba(0,0,0,0.92); backdrop-filter: blur(20px); z-index:10000; justify-content:center; align-items:center; overflow-y:auto; animation: modalFadeIn 0.28s ease; }
@keyframes modalFadeIn { from{opacity:0; transform: translateY(8px);} to{opacity:1; transform: translateY(0);} }
.modal.active { display:flex; }
.modal-content { background: var(--panel); backdrop-filter: blur(24px); border-radius: 22px; padding: 26px; max-width: 1000px; width: 95%; border: 1px solid var(--border); max-height: 90vh; overflow-y:auto; box-shadow: 0 8px 32px rgba(0,0,0,0.35); position:relative; }
.modal-close { position:absolute; right:14px; top:14px; background:rgba(255,255,255,0.06); border:none; color:var(--text); width:40px; height:40px; border-radius:50%; font-size:20px; line-height:36px; cursor:pointer; transition:transform .2s ease; }
.modal-close:hover { transform: translateY(-2px); }

/* Data source bubbles */
.bubble.circle { width:84px; height:84px; border-radius:50%; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid var(--border); cursor:pointer; box-shadow: 0 10px 28px rgba(0,0,0,0.35); transition: transform .18s ease, box-shadow .18s ease; }
.bubble.circle:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(0,0,0,0.45); }
.bubble-icon { font-size:30px; }

/* Manual modal ‚Äî compact centered card */
.manual-modal-inner {
  width: 460px; max-width: 92vw; margin: 60px auto; display:flex; flex-direction:column; gap:12px;
  background: linear-gradient(180deg, rgba(59,130,246,0.10), rgba(147,51,234,0.10));
  border: 1px solid rgba(147,51,234,0.30);
  padding: 18px; border-radius: 18px; box-shadow: 0 22px 48px rgba(0,0,0,0.55);
}
.glass-title { font-size:18px; font-weight:900; color:var(--text); margin-bottom:6px; letter-spacing:0.3px; }
.manual-field { display:flex; flex-direction:column; gap:6px; }
.manual-label { font-size:12px; color:var(--muted); font-weight:800; }
.manual-input {
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
  background: rgba(255,255,255,0.06); color: var(--text); font-weight:800; outline:none; transition:border-color .2s;
}
.manual-input:focus { border-color: #93c5fd; }
.manual-modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:6px; }

/* Image modal ‚Äî upgraded panel */
.image-header {
  font-size:20px; font-weight:900; background:linear-gradient(90deg,#6ec2ff,#7c3aed);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:8px;
}
.image-grid { display:flex; gap:12px; align-items:flex-start; }
.image-preview-box {
  width:360px; height:260px; background:linear-gradient(180deg,#000,#070707);
  border-radius:14px; overflow:hidden; display:flex; align-items:center; justify-content:center; border:1px solid var(--border);
}
#imgPreview { width:100%; height:100%; object-fit:contain; display:none; }
#imgCanvas { display:none; }
.img-stats { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px; }
.stat-pill { padding:8px; border-radius:10px; background:rgba(255,255,255,0.06); border:1px solid var(--border); font-size:12px; font-weight:800; color:var(--text); }
.progress-line { height:6px; background:rgba(255,255,255,0.12); border-radius:999px; overflow:hidden; }
.progress-bar { height:100%; width:0%; background:linear-gradient(90deg,#4ade80,#22d3ee); box-shadow:0 8px 24px rgba(74,222,128,0.28); }

/* CSV modal ‚Äî polished */
.csv-grid { display:flex; flex-direction:column; gap:10px; padding:8px 0; }
.csv-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.csv-pill { padding:8px; border-radius:12px; background:rgba(255,255,255,0.06); border:1px solid var(--border); font-size:12px; font-weight:800; color:var(--text); }
.csv-drop {
  width:100%; background:rgba(255,255,255,0.06); border:2px dashed rgba(255,255,255,0.18);
  padding:20px; border-radius:14px; text-align:center; font-weight:800; color:var(--muted);
}
.csv-drop.drag { border-color:#93c5fd; background:rgba(59,130,246,0.12); color:#93c5fd; }

/* Advice panel */
.ai-advice-panel {
  position: fixed; right: 18px; top: 110px;
  width: 440px; max-height: 70vh;
  background: linear-gradient(180deg, rgba(10,10,10,0.95), rgba(6,6,6,0.95));
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 22px 48px rgba(0,0,0,0.7), inset 0 0 40px rgba(124,58,237,0.12);
  padding: 14px; border-radius: 14px; color: #fff; z-index: 20000; overflow:auto; display:none;
}
.ai-advice-panel .title { font-weight:900; margin-bottom:10px; color:#ffd700; font-size:15px; letter-spacing:0.4px }
.ai-advice-panel .close { position:absolute; right:8px; top:6px; background:transparent; border:none; color:#fff; font-size:16px; cursor:pointer }
.advice-grid { display:flex; flex-direction:column; gap:8px; }
.advice-item { display:flex; align-items:flex-start; gap:10px; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.06); }
.advice-badge { font-weight:900; min-width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#000; }
.badge-green { background:#86efac; }
.badge-yellow { background:#fde68a; }
.badge-orange { background:#fdba74; }
.badge-red { background:#fca5a5; }
.advice-text { font-size:12px; line-height:1.55; }
.advice-title { color:#fff; font-weight:900; }
.advice-note { color:rgba(255,255,255,0.9); }

/* Toast */
#global-toast { position: fixed; right: 18px; bottom: 18px; z-index: 30000; }
.message {
  padding: 12px 15px; border-radius: 10px; margin: 15px 0; font-size: 12px; border: 1px solid var(--border);
  display:flex; align-items:center; gap:10px; animation: messageSlide 0.3s ease;
}
@keyframes messageSlide { from { transform: translateX(14px); opacity:0; } to { transform: translateX(0); opacity:1; } }
.message.success { background: rgba(74,222,128,0.15); border-color: rgba(74,222,128,0.35); color: #4ade80; }
.message.error { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.35); color: #ef4444; }
.message.loading { background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.35); color: #60a5fa; }
.message.info { background: rgba(251,191,36,0.15); border-color: rgba(251,191,36,0.35); color: #fbbf24; }
.spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #4ade80; border-radius:50%; width:30px; height:30px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

 50%{ transform:scale(1.08); filter: drop-shadow(0 0 22px rgba(255,43,43,0.35)); } 100%{ transform:scale(1); } }
.see-inside-btn.pulse { animation: seePulse 1.6s ease-in-out infinite; }


@media(max-width:768px){
    .gov-topbar {
        padding: 8px 16px;
    }

    .gov-emblem {
        width: 40px;
        height: 40px;
    }

    .gov-topbar-text span:last-child {
        font-size: 0.85rem;
    }

    .gov-topbar-right {
        display: none;
    }

    .app-header {
        top: 56px;
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        padding: 12px 16px;
    }

    .main-content {
        margin-top: 120px !important;
    }
}

/* FIR Filter Panel Styles */
.fir-filter-panel {
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(24px);
    border: 1px solid rgba(0, 212, 255, 0.3);
    border-radius: 16px;
    padding: 20px;
    margin: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}

.fir-filter-title {
    font-size: 18px;
    font-weight: 900;
    margin-bottom: 15px;
    background: linear-gradient(135deg, #00d4ff, #06ffa5);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.fir-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.fir-control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.fir-control-label {
    font-size: 13px;
    color: rgba(255,255,255,0.7);
    font-weight: 700;
}

.fir-input {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(0, 212, 255, 0.3);
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    font-weight: 600;
    outline: none;
    transition: all 0.3s;
}

.fir-input:focus {
    border-color: #00d4ff;
    box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
}

.fir-canvas-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 15px;
}

.fir-canvas-box {
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 12px;
    padding: 15px;
}

.fir-canvas-title {
    font-size: 14px;
    font-weight: 900;
    color: #00d4ff;
    margin-bottom: 10px;
}

.fir-canvas {
    width: 100%;
    height: 200px;
    border-radius: 8px;
    background: #000;
}

@media(max-width: 1000px) {
    .fir-canvas-container {
        grid-template-columns: 1fr;
    }
}

</style>
</head>
<body>

<!-- TOP GOV HEADER -->
<div class="gov-topbar">
    <div class="gov-topbar-left">
        <div class="gov-emblem">
            <img src="image.jpg" alt="Student of India Emblem">
        </div>
        <div class="gov-topbar-text">
            <span>Student of India</span>
            <span>Health and Family Welfare</span>
        </div>
    </div>
    <div class="gov-topbar-right">
        Cardiology AI | Pilot | Internal Use Only
    </div>
</div>

<!-- APP HEADER BAND -->
<div class="app-header">
    <div class="app-header-left">
        <a href="https://ssureshkxmar.github.io/cardiology/heart.html" class="back-button">
            <span>‚Üê</span>
            <span>Back</span>
        </a>
        <div class="app-header-content">
            <span class="app-title">Adaptive Cardiology Care</span>
            <span class="app-subtitle">Real-time cardiac monitoring & AI analysis</span>
        </div>
    </div>
    <div class="app-header-right">
        <button class="menu-button" onclick="openDataSourceModal()">üóÑÔ∏è Data source</button>
        <button class="menu-button" onclick="openFIRFilterModal()">üìä FIR Filter</button>
        <div id="hrBeacon" class="beacon-yellow" title="HR beacon"></div>
    </div>
</div>

<div class="main-content">
  <!-- Left: heart video -->
  <div class="card heart-section" style="display:flex;flex-direction:column;position:relative;">
    <div id="heartBox">
      <div class="video-overlay">
        <div class="badge neon" id="overlayRhythm">Rhythm: Sinus</div>
        <div class="badge hr">HR: <span id="overlayHR">0</span> bpm</div>
      </div>
      <video id="heartVideo"
             src="heart.mp4"
             autoplay
             muted
             loop
             playsinline
             preload="auto"
             style="border-radius:12px; display:block;">
        Your browser does not support the video tag.
      </video>
    </div>

    <!-- BPM slider under the video -->
    <div style="width:100%;margin-top:10px;">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <label style="color:var(--text);font-size:14px;font-weight:900;">
          ‚ù§Ô∏è Heart rate (BPM): <span id="bpmValue">0</span>
        </label>
        <div class="tooltip" data-tip="Set the simulated heart rate to drive video speed and signals.">‚ÑπÔ∏è</div>
        <button class="monitor-btn" onclick="toggleHRLock()">HR lock: <span id="hrLockLabel">Off</span></button>
        <button class="monitor-btn" onclick="toggleAudio()">Beep: <span id="audioLabel">On</span></button>
      </div>
      <input id="bpmSlider" type="range" min="0" max="180" value="0" style="width:100%;margin-top:6px;" oninput="updateBPM(this.value)">
      <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;">
        <button class="monitor-btn" onclick="setRhythmMode('regular')">Regular</button>
        <button class="monitor-btn" onclick="setRhythmMode('irregular')">Irregular</button>
        <button class="monitor-btn" onclick="presetArrhythmia('afib')">A-Fib</button>
        <button class="monitor-btn" onclick="presetArrhythmia('vtach')">V-Tach</button>
        <button class="monitor-btn" onclick="togglePressure()">Toggle pressure</button>
        <button class="monitor-btn" onclick="toggleValves()">Valves: <span id="valveMode">Auto</span></button>
        <button class="monitor-btn" onclick="togglePacing()">Pacing: <span id="pacingMode">Off</span></button>
        <button class="monitor-btn" onclick="presetHR(48)">Brady</button>
        <button class="monitor-btn" onclick="presetHR(72)">Normal</button>
        <button class="monitor-btn" onclick="presetHR(110)">Tachy</button>
        <button class="monitor-btn" onclick="presetHR(140)">High Tachy</button>
        <button class="monitor-btn" onclick="exportMonitorPNG()">Export monitor PNG</button>
      </div>
    </div>

    <!-- Inner view button -->
    </div>

  <div class="card ecg-section">
    <div class="section-title">üìà Patient monitor</div>
    <div class="monitor">
      <div class="monitor-screen" id="monitorScreen">
        <canvas id="monitorCanvas" class="monitor-canvas"></canvas>
        <canvas id="monitorGrid" class="monitor-grid"></canvas>

        <!-- Top-right HR -->
        <div style="position:absolute;right:12px;top:12px;z-index:30;pointer-events:none;text-align:right;color:#9bf;text-shadow:0 0 8px rgba(110,194,255,0.06)">
          <div style="font-weight:900;font-size:34px;color:#4aff4a" id="displayHR">0</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.6)">HR bpm</div>
          <div style="margin-top:6px;font-size:11px;color:#9bf">Trend: <span id="hrTrendLabel">--</span></div>
        </div>

        <!-- Bottom-right SpO2 -->
        <div style="position:absolute;right:12px;bottom:12px;z-index:30;pointer-events:none;text-align:right;">
          <div class="vital-item"><div class="bedside-label">SpO2</div><div class="small-blue" id="displaySpO2">0%</div></div>
        </div>

        <!-- ECG quick presets -->
        <div style="position:absolute;left:12px;top:12px;z-index:32;pointer-events:auto;display:flex;gap:6px;flex-wrap:wrap;">
          <button class="monitor-btn" onclick="presetHR(48)">Brady</button>
          <button class="monitor-btn" onclick="presetHR(72)">Normal</button>
          <button class="monitor-btn" onclick="presetHR(110)">Tachy</button>
          <button class="monitor-btn" onclick="presetHR(140)">High Tachy</button>
        </div>

        <!-- Embedded signals -->
        <div class="monitor-signals" aria-label="Embedded signals">
          <div class="signal-box">
            <div class="signal-title">Electrical signal (EKG - Lead II)</div>
            <canvas id="ekgSignal"></canvas>
          </div>
          <div class="signal-box">
            <div class="signal-title mech">Mechanical pulse (contraction amplitude)</div>
            <canvas id="mechSignal"></canvas>
          </div>
        </div>
      </div>

      <div class="monitor-leftbar" id="monitorLeftBar">
        <div class="monitor-header">
          <div style="font-weight:900;color:#4aff4a">Bedside monitor</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="monitor-btn" onclick="openAnalysisModal()">Analysis</button>
            <!-- Removed Manual and CSV buttons from bedside monitor as requested -->
          </div>
        </div>

        <!-- Bedside live metrics -->
        <div class="bedside-metrics" aria-label="Bedside metrics">
          <div class="bedside-row"><div class="bedside-label">Beat period</div><div class="bedside-value" id="bedBeatPeriod">0.00 s</div></div>
          <div class="bedside-row"><div class="bedside-label">Phase</div><div class="bedside-value" id="bedPhase">0.00 (0‚Äì1)</div></div>
          <div class="bedside-row"><div class="bedside-label">Valves</div><div class="bedside-value" id="bedValves">Auto</div></div>
          <div class="bedside-row"><div class="bedside-label">Status</div><div class="bedside-value" id="bedStatus">Stopped</div></div>
        </div>

        <!-- Trend sparkline & controls -->
        <div class="vital-item">
          <div class="bedside-label">HR sparkline (last 60s)</div>
          <canvas id="hrSparkline" width="300" height="64" style="width:100%;height:64px;background:rgba(0,0,0,0.4);border-radius:8px"></canvas>
          <div style="display:flex;gap:6px; margin-top:6px; flex-wrap:wrap;">
            <div class="csv-pill" id="trendBadge">Stable</div>
            <div class="csv-pill">RR Var: <span id="rrVarBadge">--</span></div>
            <div class="csv-pill">Smooth:
              <select id="sparkSmoothSel" class="manual-input" style="max-width:80px;padding:4px 8px;" onchange="setSparkSmooth(this.value)">
                <option value="0">0</option><option value="1">1</option><option value="2">2</option>
                <option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
              </select>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="monitor-btn" id="aiAdviceBtn" onclick="generateAIDoctorAdvice()">AI doctor advice</button>
          <button class="monitor-btn" onclick="downloadHR()">Export HR CSV</button>
          <button class="monitor-btn" onclick="resetMonitorSoft()">Reset monitor</button>
          <button class="monitor-btn" onclick="resetMonitor()">Full reset</button>
        </div>
      </div>
    </div>

    <div id="aiAdvicePanel" class="ai-advice-panel" role="dialog" aria-live="polite">
      <button class="close" onclick="document.getElementById('aiAdvicePanel').style.display='none'">‚úï</button>
      <div class="title">AI doctor advice</div>
      <div id="aiAdviceContent">No advice yet.</div>
    </div>
  </div>

  <!-- Patient section: replace uppercase name with compact live data line; symptoms on the right -->
  <div class="card patient-section">
    <div class="patient-panel" style="width:100%">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
        <div style="flex:1;display:flex;flex-direction:column;justify-content:center;">
          <div class="patient-name" id="patient-name">--</div>
          <div id="patient-updated" class="patient-updated">--</div>
        </div>
        <div style="min-width:300px;display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
          <div class="alarm-box" id="alarmBox" style="font-weight:900;">ALARM: NORMAL</div>
          <div id="patient-symptoms" class="patient-symptoms">--</div>
          <div id="patient-warnings" style="margin-top:8px;color:#ffbaba;font-size:12px;text-align:right;max-width:420px;display:none"></div>
          <div id="patient-extra" class="patient-extra"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data source modal -->
<div class="modal" id="dataSourceModal">
  <div class="modal-content" style="background:transparent;border:none;box-shadow:none;padding:14px;max-width:820px;">
    <button class="modal-close" onclick="closeModal('dataSourceModal')">‚Äî</button>
    <div style="display:flex;gap:48px;align-items:center;justify-content:center;padding:56px;flex-wrap:wrap;">
      <div class="bubble circle" aria-label="Wearable Device" title="Wearable Device" onclick="openWearableModalAuto()"><div class="bubble-icon">‚åö</div></div>
      <div class="bubble circle" aria-label="Manual Input" title="Manual Input" onclick="openManualModal()"><div class="bubble-icon">‚úçÔ∏è</div></div>
      <div class="bubble circle" aria-label="Hardware Device" title="Hardware Device" onclick="showHardwareComingSoon()"><div class="bubble-icon">üîß</div></div>
      <div class="bubble circle" aria-label="Image Input" title="Image Input" onclick="openImageModal()"><div class="bubble-icon">üñºÔ∏è</div></div>
      <div class="bubble circle" aria-label="Upload CSV" title="Upload CSV Dataset" onclick="openCsvModal()"><div class="bubble-icon">üìÅ</div></div>
    </div>
  </div>
</div>

<!-- Options modal -->
<div class="modal" id="optionsModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('optionsModal')">‚úï</button>
    <div class="glass-title">Monitor options</div>
    <div class="csv-grid">
      <div class="csv-row">
        <div class="csv-pill">Grid brightness</div>
        <input type="range" min="0.2" max="1.5" step="0.1" value="1.0" class="manual-input" id="gridBrightInp" oninput="setGridBright(this.value)">
      </div>
      <div class="csv-row">
        <div class="csv-pill">ECG intensity</div>
        <input type="range" min="0.6" max="2.0" step="0.1" value="1.0" class="manual-input" id="ecgIntensityInp" oninput="setECGIntensity(this.value)">
      </div>
      <div class="csv-row">
        <div class="csv-pill">Resp intensity</div>
        <input type="range" min="0.6" max="2.0" step="0.1" value="1.0" class="manual-input" id="respIntensityInp" oninput="setRespIntensity(this.value)">
      </div>
      <div class="csv-row">
        <div class="csv-pill">Respiratory rate (override)</div>
        <input type="number" min="4" max="60" value="16" class="manual-input" id="respOverrideInp" oninput="respOverride(this.value)" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button class="monitor-btn" onclick="closeModal('optionsModal')">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Image modal -->
<div class="modal" id="imageModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('imageModal')">‚úï</button>
    <div class="image-header">üì∑ Upload ECG image</div>
    <div class="csv-grid" style="margin-bottom:10px;">
      <input id="imageInput" type="file" accept="image/*" style="border-radius:10px;padding:10px;background:rgba(255,255,255,0.06);border:1px solid var(--border);color:var(--text);" />
      <div class="progress-line"><div id="imgProgressBar" class="progress-bar"></div></div>
    </div>

    <div class="image-grid">
      <div class="image-preview-box">
        <img id="imgPreview" src="" alt="preview" />
        <canvas id="imgCanvas" width="360" height="260"></canvas>
        <div id="imgPlaceholder" style="color:rgba(255,255,255,0.35);font-weight:900;">No image</div>
      </div>
      <div style="flex:1;display:flex;flex-direction:column;gap:8px;">
        <div id="imageAnalysisResult" style="padding:12px;border-radius:12px;background:rgba(255,255,255,0.06);min-height:140px;color:var(--text);font-weight:800;">No analysis yet.</div>
        <div class="img-stats">
          <div class="stat-pill">RR avg: <span id="statRR">--</span> ms</div>
          <div class="stat-pill">RR std: <span id="statRRStd">--</span> ms</div>
          <div class="stat-pill">QRS amp: <span id="statAmp">--</span></div>
          <div class="stat-pill">Lead guess: <span id="statLead">--</span></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:auto;">
          <button class="monitor-btn" onclick="analyzeImage()">Analyze</button>
          <button id="applyImageBtn" class="monitor-btn" onclick="applyImageDataConfirmed()">Apply</button>
          <button class="monitor-btn" onclick="closeModal('imageModal')">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CSV modal -->
<div class="modal" id="csvModal">
  <div class="modal-content" style="max-width:780px;">
    <button class="modal-close" onclick="closeModal('csvModal')">‚úï</button>
    <div class="glass-title">Upload CSV dataset</div>
    <div class="csv-grid">
      <div class="csv-row">
        <input id="csvPatientId" type="text" placeholder="Patient ID (ex: patient_123)" class="manual-input" value="patient_123" />
        <div class="csv-pill">Playback:
          <select id="csvPlaybackSel" class="manual-input" style="max-width:140px;">
            <option value="10">10s/person</option>
            <option value="6">6s/person</option>
            <option value="15">15s/person</option>
          </select>
        </div>
      </div>
      <div id="csvDrop" class="csv-drop">Drag & drop CSV here or choose below</div>
      <input id="csvInput" type="file" accept=".csv,text/csv" class="manual-input" />
      <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;">
        <div id="csvUploadResult" style="flex:1;color:#9ca3af;font-size:13px;"></div>
        <button class="monitor-btn" onclick="uploadCsvLocal()">Load</button>
        <button class="monitor-btn" onclick="applyCsvData()">Play</button>
        <button class="monitor-btn" onclick="closeModal('csvModal')">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Wearable modal -->
<div class="modal" id="wearableModal">
  <div class="modal-content" style="background:transparent;border:none;box-shadow:none;padding:0;max-width:none;">
    <button class="modal-close" onclick="closeModal('wearableModal')">‚Äî</button>
    <div style="display:flex;align-items:center;justify-content:center;padding:48px;">
      <div class="bubble circle" aria-label="Scan Devices" title="Scan Devices" onclick="scanBluetooth()">
        <div class="bubble-icon">üîç</div>
      </div>
    </div>
  </div>
</div>

<!-- Manual modal (centered compact) -->
<div class="modal" id="manualModal">
  <div class="modal-content" style="background:transparent;border:none;box-shadow:none;padding:0;max-width:none;">
    <button class="modal-close" onclick="closeModal('manualModal')">‚Äî</button>
    <div class="manual-modal-inner">
      <div class="glass-title">Manual vitals</div>
      <div class="manual-field"><div class="manual-label">Name</div><input id="manualName" type="text" class="manual-input" placeholder="Name"></div>
      <div class="manual-field"><div class="manual-label">Age (optional)</div><input id="manualAge" type="number" min="0" max="150" class="manual-input" placeholder="Age"></div>
      <div class="manual-field"><div class="manual-label">Heart rate (bpm)</div><input id="manualHR" type="number" min="20" max="220" class="manual-input" placeholder="Heart rate"></div>
      <div class="manual-field"><div class="manual-label">SpO2 (%)</div><input id="manualSpO2" type="number" min="50" max="100" class="manual-input" placeholder="SpO2"></div>
      <div class="manual-field"><div class="manual-label">Respiration (breaths/min)</div><input id="manualResp" type="number" min="4" max="60" class="manual-input" placeholder="Respiration"></div>
      <div class="manual-field"><div class="manual-label">Blood pressure (optional, mmHg)</div><input id="manualBP" type="text" class="manual-input" placeholder="e.g., 120/80"></div>
      <div class="manual-field"><div class="manual-label">ECG notes (optional)</div><input id="manualEcgNotes" type="text" class="manual-input" placeholder="Notes"></div>
      <div class="manual-modal-actions">
        <button class="monitor-btn" onclick="applyManualInputs()">Apply</button>
        <button class="monitor-btn" onclick="closeModal('manualModal')">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Hardware modal -->
<div class="modal" id="hardwareModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('hardwareModal')">‚úï</button>
    <div class="coming-soon" style="background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.2)); border: 2px solid rgba(251,191,36,0.4); padding: 30px; border-radius: 20px; text-align: center; margin: 20px 0; animation: comingSoonPulse 2s ease-in-out infinite;">
      <div class="coming-soon-icon" style="font-size:42px; filter: drop-shadow(0 0 12px rgba(251,191,36,0.6)); margin-bottom:8px;">üöß</div>
      <div class="coming-soon-title" style="font-size:18px; font-weight:900; color:#ffd573; letter-spacing:0.6px;">Future hardware integration</div>
      <div class="coming-soon-desc" style="color:var(--text); opacity:0.92; margin-top:6px; font-weight:800;">
        ESP32 and Arduino hardware integration is being designed.<br>
        Animated port mapping, live calibration, and sensor fusion panels will appear here.
      </div>
    </div>
  </div>
</div>

<!-- Analysis modal -->
<div class="modal" id="analysisModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('analysisModal')">‚úï</button>
    <h2 style="margin:0 0 10px 0;">üë§ Person <span id="modalPerson">0</span> - Individual analysis</h2>
    <p id="modalInfo" style="margin-bottom:20px;"></p>

    <div style="background:rgba(255,255,255,0.06);border:1px solid var(--border);padding:18px;border-radius:15px;margin:20px 0;">
      <h3 style="margin:0 0 10px 0;">üìä Risk assessment</h3>
      <div class="metrics" style="display:grid;grid-template-columns: 1fr;gap:10px;">
        <div class="bedside-row"><div class="bedside-label">Risk score</div><div class="bedside-value" id="modalRisk">--</div></div>
      </div>
      <div id="modalCat" style="margin-top:10px;"></div>

      <div class="charts-container" style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:25px 0;">
        <div class="chart-box" style="background: rgba(255,255,255,0.06); border-radius: 15px; border: 1px solid var(--border); padding: 18px;">
          <h4 style="color:#4ade80;font-size:15px;margin-bottom:12px;font-weight:900;">üìä Risk assessment distribution</h4>
          <canvas id="riskChart"></canvas>
        </div>
        <div class="chart-box" style="background: rgba(255,255,255,0.06); border-radius: 15px; border: 1px solid var(--border); padding: 18px;">
          <h4 style="color:#4ade80;font-size:15px;margin-bottom:12px;font-weight:900;">üìà Person-to-person flow</h4>
          <canvas id="flowChart"></canvas>
        </div>
      </div>
    </div>

    <div class="results-section" style="font-size:12px; line-height:1.8;">
      <h4 style="color:#4ade80;font-size:16px;margin:25px 0 15px 0;font-weight:900;">ü©∫ Patient metrics</h4>
      <div class="metrics" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div class="bedside-row"><div class="bedside-label">Blood pressure</div><div class="bedside-value" id="modalBP">--</div></div>
        <div class="bedside-row"><div class="bedside-label">Cholesterol</div><div class="bedside-value" id="modalChol">--</div></div>
        <div class="bedside-row"><div class="bedside-label">Max heart rate</div><div class="bedside-value" id="modalMaxHR">--</div></div>
        <div class="bedside-row"><div class="bedside-label">ST depression</div><div class="bedside-value" id="modalST">--</div></div>
      </div>

      <h4 style="color:#4ade80;font-size:16px;margin:25px 0 15px 0;font-weight:900;">‚ù§Ô∏è AI doctor recommendation</h4>
      <div id="modalRec"></div>

      <h4 style="color:#4ade80;font-size:16px;margin:25px 0 15px 0;font-weight:900;">üíä Maintain healthy lifestyle</h4>
      <ul style="margin-left:20px;margin-top:10px;">
        <li style="margin:8px 0;">Regular aerobic exercise: 150 min/week</li>
        <li style="margin:8px 0;">Mediterranean-style eating pattern</li>
        <li style="margin:8px 0;">Stress reduction & meditation</li>
        <li style="margin:8px 0;">Adequate sleep: 7‚Äì8 hours</li>
        <li style="margin:8px 0;">Sodium awareness</li>
      </ul>

      <h4 style="color:#4ade80;font-size:16px;margin:25px 0 15px 0;font-weight:900;">üìà Person-to-person flow</h4>
      <table class="analysis-table" style="width:100%;border-collapse:collapse;margin:20px 0;font-size:11px;background:rgba(255,255,255,0.06);border-radius:10px;overflow:hidden;">
        <tr><th>#</th><th>Age</th><th>BP</th><th>Chol</th><th>HR</th><th>Risk%</th><th>Category</th></tr>
        <tbody id="flowTable"></tbody>
      </table>
    </div>

    <div class="footer" style="text-align:center;padding:20px;color:rgba(255,255,255,0.55);font-size:11px;margin-top:20px;">¬© 2025 Adaptive Cardiology Care</div>
  </div>
</div>

<div id="global-toast"></div>


<!-- FIR Filter Modal -->
<div class="modal" id="firFilterModal">
  <div class="modal-content" style="max-width: 1200px;">
    <button class="modal-close" onclick="closeModal('firFilterModal')">‚úï</button>
    <div class="fir-filter-panel">
      <div class="fir-filter-title">üìä FIR Filter - ECG Signal Processing</div>

      <div class="fir-controls">
        <div class="fir-control-group">
          <label class="fir-control-label">Filter Type</label>
          <select id="firFilterType" class="fir-input" onchange="updateFIRFilter()">
            <option value="lowpass">Low Pass</option>
            <option value="highpass">High Pass</option>
            <option value="bandpass" selected>Band Pass</option>
            <option value="bandstop">Band Stop</option>
          </select>
        </div>

        <div class="fir-control-group">
          <label class="fir-control-label">Cutoff Frequency (Hz)</label>
          <input type="number" id="firCutoff" class="fir-input" value="40" min="1" max="250" onchange="updateFIRFilter()">
        </div>

        <div class="fir-control-group">
          <label class="fir-control-label">Filter Order</label>
          <input type="number" id="firOrder" class="fir-input" value="50" min="10" max="200" step="10" onchange="updateFIRFilter()">
        </div>

        <div class="fir-control-group">
          <label class="fir-control-label">Sampling Rate (Hz)</label>
          <input type="number" id="firSampleRate" class="fir-input" value="500" min="100" max="1000" onchange="updateFIRFilter()">
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="monitor-btn" onclick="applyFIRFilter()">Apply Filter</button>
        <button class="monitor-btn" onclick="resetFIRFilter()">Reset</button>
        <button class="monitor-btn" onclick="exportFilteredSignal()">Export Filtered CSV</button>
      </div>

      <div class="fir-canvas-container">
        <div class="fir-canvas-box">
          <div class="fir-canvas-title">Original ECG Signal</div>
          <canvas id="firOriginalCanvas" class="fir-canvas"></canvas>
        </div>

        <div class="fir-canvas-box">
          <div class="fir-canvas-title">Filtered ECG Signal</div>
          <canvas id="firFilteredCanvas" class="fir-canvas"></canvas>
        </div>
      </div>

      <div class="fir-canvas-container">
        <div class="fir-canvas-box">
          <div class="fir-canvas-title">Frequency Response</div>
          <canvas id="firFrequencyCanvas" class="fir-canvas"></canvas>
        </div>

        <div class="fir-canvas-box">
          <div class="fir-canvas-title">Filter Coefficients</div>
          <canvas id="firCoeffCanvas" class="fir-canvas"></canvas>
        </div>
      </div>

      <div style="margin-top: 20px; padding: 15px; background: rgba(0, 212, 255, 0.1); border-radius: 12px; border: 1px solid rgba(0, 212, 255, 0.3);">
        <div style="font-weight: 900; color: #00d4ff; margin-bottom: 10px;">Filter Information:</div>
        <div id="firFilterInfo" style="font-size: 13px; color: rgba(255,255,255,0.9); line-height: 1.8;">
          Configure filter parameters above and click "Apply Filter" to process ECG signal.
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<script>
  // Fixed backend base
  const API = 'https://adaptivecardiobackend.onrender.com';

  // State
  let data = []; let risks = []; let idx = 0;
  let bpm = 0;
  let charts = {};
  let HR = 0;              // start at 0 ‚Äî initial display must be 0
  let manualHRSet = false;
  let RESP = 16;
  let LAST_ANALYSIS = null;
  let LOADED_CSV_PATIENTID = null;

  let audioCtx = null;
  let mechScale = 0.0;
  let csvPlaybackTimer = null; let csvPlaybackIndex = 0;

  let pacingOn = false;
  let valvesMode = 'Auto';
  let rhythmMode = 'regular';
  let arrhythmiaMode = null; // 'afib' | 'vtach' | null
  let hrLocked = false;
  let audioOn = true;
  let sparkSmooth = 3;

  const heartVideo = document.getElementById('heartVideo');

  // Persistence keys
  const STORAGE_STATE_KEY = 'ACC_STATE';
  const STORAGE_CONTEXT_KEY = 'ACC_CONTEXT';

  // Time and clock
  function pad2(n){ return n<10 ? '0'+n : ''+n; }
  function updateClock(){
    const d = new Date();
    const hh = pad2(d.getHours());
    const mm = pad2(d.getMinutes());
    const ss = pad2(d.getSeconds());
    const el = document.getElementById('headerClock');
    if (el) el.textContent = hh + ':' + mm + ':' + ss;
  }
  setInterval(updateClock, 1000);
  updateClock();

  // Theme
  function toggleTheme(){
    const root = document.documentElement;
    const cur = root.getAttribute('data-theme') || 'dark';
    root.setAttribute('data-theme', cur === 'dark' ? 'light' : 'dark');
    persistState();
  }

  function toast(html, t='info', ms=1800){
    let area = document.getElementById('global-toast');
    if(!area){ area = document.createElement('div'); area.id='global-toast'; area.style.position='fixed'; area.style.right='18px'; area.style.bottom='18px'; area.style.zIndex=30000; document.body.appendChild(area); }
    const box = document.createElement('div');
    box.className = 'message ' + t;
    box.innerHTML = html;
    area.appendChild(box);
    setTimeout(()=>{ try{ area.removeChild(box); }catch(e){} }, ms);
  }

  function ensureVideoPlaying() {
    if (!heartVideo) return;
    heartVideo.muted = true;
    const playPromise = heartVideo.play();
    if (playPromise && typeof playPromise.then === 'function') {
      playPromise.then(()=>{}).catch(()=>{});
    }
  }

  function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }

  function setVideoRateFromHR(){
    if (!heartVideo) return;
    const base = 72;
    const currentHR = HR ?? bpm ?? 0;
    const rate = currentHR <= 0 ? 0 : clamp(currentHR / base, 0.2, 3.0);
    heartVideo.playbackRate = rate;
    document.getElementById('overlayHR').textContent = Math.round(currentHR||0);
    document.getElementById('overlayRhythm').textContent = 'Rhythm: ' + (
      arrhythmiaMode === 'afib' ? 'Atrial Fibrillation' :
      arrhythmiaMode === 'vtach' ? 'Ventricular Tachycardia' :
      (rhythmMode==='regular'?'Sinus':'Irregular')
    );
    updateHRBeacon(hrTier(currentHR));
    if (currentHR <= 0){
      try { heartVideo.pause(); } catch(e){}
    } else {
      ensureVideoPlaying();
    }
  }

  /* Monitor setup */
  const monitorCanvas = document.getElementById('monitorCanvas');
  const monitorGrid = document.getElementById('monitorGrid');
  const monitorScreen = document.getElementById('monitorScreen');
  const monitorCtx = monitorCanvas.getContext('2d');
  const gridCtx = monitorGrid.getContext('2d');

  const ekgSignal = document.getElementById('ekgSignal');
  const mechSignal = document.getElementById('mechSignal');
  const ekgCtx = ekgSignal ? ekgSignal.getContext('2d') : null;
  const mechCtx = mechSignal ? mechSignal.getContext('2d') : null;

  const bedBeatPeriodEl = document.getElementById('bedBeatPeriod');
  const bedPhaseEl = document.getElementById('bedPhase');
  const bedValvesEl = document.getElementById('bedValves');
  const bedStatusEl = document.getElementById('bedStatus');

  const hrSpark = document.getElementById('hrSparkline');
  const hrSparkCtx = hrSpark.getContext('2d');
  const hrTrendLabel = document.getElementById('hrTrendLabel');
  const trendBadge = document.getElementById('trendBadge');
  const rrVarBadge = document.getElementById('rrVarBadge');
  const hrHistory = [];
  let lastTrendUpdate = performance.now();

  function resizeMonitor(){
    const r = monitorScreen.getBoundingClientRect();
    if (!r.width || !r.height) return;
    const dpr = window.devicePixelRatio || 1;
    monitorCanvas.width = r.width * dpr;
    monitorCanvas.height = r.height * dpr;
    monitorCanvas.style.width = r.width + 'px';
    monitorCanvas.style.height = r.height + 'px';
    monitorGrid.width = monitorCanvas.width;
    monitorGrid.height = monitorCanvas.height;
    monitorGrid.style.width = monitorCanvas.style.width;
    monitorGrid.style.height = monitorCanvas.style.height;
    if (ekgSignal) {
      const r2 = ekgSignal.getBoundingClientRect();
      ekgSignal.width = r2.width * (window.devicePixelRatio || 1);
      ekgSignal.height = r2.height * (window.devicePixelRatio || 1);
      ekgSignal.style.width = r2.width + 'px'; ekgSignal.style.height = r2.height + 'px';
    }
    if (mechSignal) {
      const r3 = mechSignal.getBoundingClientRect();
      mechSignal.width = r3.width * (window.devicePixelRatio || 1);
      mechSignal.height = r3.height * (window.devicePixelRatio || 1);
      mechSignal.style.width = r3.width + 'px'; mechSignal.style.height = r3.height + 'px';
    }
    drawGrid();
  }

  window.addEventListener('resize', resizeMonitor);
  window.addEventListener('DOMContentLoaded', ()=>{
    // Restore state if exists
    restoreState();
    resizeMonitor();
    setVideoRateFromHR();
    startMonitorLoop();
    updatePatientConditionPanel();
    drawSparkline();
    initCsvDrop();
    document.getElementById('bpmValue').textContent = HR ?? 0;
    document.getElementById('bpmSlider').value = HR ?? 0;
    document.getElementById('audioLabel').textContent = audioOn ? 'On' : 'Off';
    document.getElementById('hrLockLabel').textContent = hrLocked ? 'On' : 'Off';
  });

  function drawGrid(){
    const w = monitorGrid.width, h = monitorGrid.height;
    gridCtx.clearRect(0,0,w,h);
    gridCtx.fillStyle = '#000'; gridCtx.fillRect(0,0,w,h);

    const mm = Math.max(6, Math.round(w/160));
    const alphaMinor = 0.08 * (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-bright')) || 1.0);
    const alphaMajor = 0.18 * (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-bright')) || 1.0);

    gridCtx.strokeStyle = `rgba(255,0,0,${alphaMinor})`; gridCtx.lineWidth = 1;
    for(let x=0;x<w;x+=mm){ gridCtx.beginPath(); gridCtx.moveTo(x+0.5,0); gridCtx.lineTo(x+0.5,h); gridCtx.stroke(); }
    for(let y=0;y<h;y+=mm){ gridCtx.beginPath(); gridCtx.moveTo(0,y+0.5); gridCtx.lineTo(w,y+0.5); gridCtx.stroke(); }

    gridCtx.strokeStyle = `rgba(255,0,0,${alphaMajor})`; gridCtx.lineWidth = 1.5;
    const major = mm*5;
    for(let x=0;x<w;x+=major){ gridCtx.beginPath(); gridCtx.moveTo(x+0.5,0); gridCtx.lineTo(x+0.5,h); gridCtx.stroke(); }
    for(let y=0;y<h;y+=major){ gridCtx.beginPath(); gridCtx.moveTo(0,y+0.5); gridCtx.lineTo(w,y+0.5); gridCtx.stroke(); }
  }

  // ECG model
  function ekgLeadII(phi, rrSec){
    const pOn = 0.12, pDur = 0.09;
    const prEnd = 0.18;
    const qOn = prEnd, qDur = 0.02;
    const rOn = qOn + 0.02, rDur = 0.04;
    const sOn = rOn + 0.04, sDur = 0.04;
    const stOn = sOn + 0.03;
    const tOn = stOn + 0.12, tDur = 0.16;
    function bump(x, m, w, a){ const z = (x-m)/w; return a * Math.exp(-0.5*z*z); }
    let v = 0;
    v += bump(phi, pOn + pDur*0.5, pDur*0.35, 0.15);
    v += bump(phi, qOn + qDur*0.5, qDur*0.25, -0.5);
    v += bump(phi, rOn + rDur*0.5, rDur*0.25, 1.8);
    v += bump(phi, sOn + sDur*0.5, sDur*0.30, -0.6);
    v += bump(phi, tOn + tDur*0.5, tDur*0.40, 0.35);
    return v;
  }

  function ekgWave(p){
    let y = 0;
    y += 0.12 * Math.exp(-((p - 0.18) ** 2) / (2 * 0.016 ** 2));
    y -= 0.16 * Math.exp(-((p - 0.28) ** 2) / (2 * 0.008 ** 2));
    y += 1.0 * Math.exp(-((p - 0.30) ** 2) / (2 * 0.006 ** 2));
    y -= 0.25 * Math.exp(-((p - 0.32) ** 2) / (2 * 0.008 ** 2));
    y += 0.20 * Math.exp(-((p - 0.62) ** 2) / (2 * 0.04 ** 2));
    return y;
  }

  const electromechDelay = 0.08;
  function mechWave(p, amp){
    const baseHR = Math.max(0, HR ?? bpm ?? 0);
    const peak = 0.30 + (electromechDelay) * (baseHR / 60);
    const s1 = Math.exp(-((p - peak) ** 2) / (2 * 0.03 ** 2));
    const s2 = Math.exp(-((p - (peak + 0.1)) ** 2) / (2 * 0.05 ** 2));
    return amp * (s1 * 1.0 + s2 * 0.4);
  }

  function drawSmallSignal(ctx, canvas, xOffset, RR, kind){
    if (!ctx || !canvas) return;
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    ctx.save(); ctx.translate(0, h/2);
    const ecgI = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ecg-intensity')) || 1.0;
    const respI = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--resp-intensity')) || 1.0;
    ctx.strokeStyle = (kind === 'Electrical') ? `rgba(94,228,255,${0.8*ecgI})` : `rgba(255,79,107,${0.8*respI})`;
    ctx.lineWidth = Math.max(1, Math.round(h / 60));
    ctx.beginPath();
    const hrUse = HR ?? bpm ?? 0;
    if (hrUse <= 0){
      ctx.moveTo(0, 0);
      ctx.lineTo(w, 0);
      ctx.stroke();
      ctx.restore();
      return;
    }
    for (let i = 0; i < w; i++){
      const t = (xOffset + i) / (25 * Math.max(6, Math.round((monitorCanvas.width) / 160)));
      const cyc = t / RR; const p = cyc - Math.floor(cyc);
      const y = (kind === 'Electrical') ? ekgWave(p) : mechWave(p, mechScale);
      const yy = -y * (kind === 'Electrical' ? h * 0.18 * ecgI : h * 0.36 * respI);
      if (i === 0) ctx.moveTo(i, yy); else ctx.lineTo(i, yy);
    }
    ctx.stroke(); ctx.restore();
  }

  let showPressure = false;
  function togglePressure(){ showPressure = !showPressure; persistState(); }
  function setRhythmMode(m){ rhythmMode = m; arrhythmiaMode = null; persistState(); }
  function presetArrhythmia(kind){
    arrhythmiaMode = kind; // 'afib' or 'vtach'
    rhythmMode = 'irregular';
    toast(`<div><strong>Arrhythmia mode:</strong> ${kind === 'afib' ? 'Atrial Fibrillation' : 'Ventricular Tachycardia'}</div>`, 'info', 1500);
    persistState();
  }

  function toggleValves(){
    valvesMode = (valvesMode === 'Auto') ? 'Closed (sim)' : (valvesMode === 'Closed (sim)') ? 'Open (sim)' : 'Auto';
    document.getElementById('valveMode').textContent = valvesMode;
    bedValvesEl.textContent = valvesMode;
    toast('<div><strong>Valves set: '+ valvesMode +'</strong></div>', 'info', 1200);
    persistState();
  }

  function togglePacing(){
    pacingOn = !pacingOn;
    document.getElementById('pacingMode').textContent = pacingOn ? 'On' : 'Off';
    toast('<div><strong>Pacing '+ (pacingOn?'enabled':'disabled') +'</strong></div>', 'info', 1200);
    persistState();
  }

  function toggleHRLock(){
    hrLocked = !hrLocked;
    document.getElementById('hrLockLabel').textContent = hrLocked ? 'On' : 'Off';
    toast('<div><strong>HR lock '+ (hrLocked?'enabled':'disabled') +'</strong></div>', 'info', 1200);
    persistState();
  }

  function toggleAudio(){
    audioOn = !audioOn;
    document.getElementById('audioLabel').textContent = audioOn ? 'On' : 'Off';
    persistState();
  }

  let lastRTime = 0;
  let lastV = 0;

  function lvPressureEnvelope(tSinceR, rr){
    const sysRise = 0.12, sysPeak = 0.20, dias = rr - 0.20;
    if (tSinceR < sysRise) return (tSinceR/sysRise);
    if (tSinceR < sysPeak) return 1.0;
    const rem = Math.max(0, dias - (tSinceR - sysPeak));
    const total = Math.max(dias, 0.001);
    return Math.max(0, rem/total)*0.5 + 0.1;
  }

  let monitorRunning = false;
  let lastFrame = performance.now();
  let xOffset = 0;

  function playBeep(freq=880, dur=0.08, vol=0.2){
    if (!audioOn) return;
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.frequency.value = freq;
      gain.gain.value = vol;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      osc.start(now);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + dur);
      osc.stop(now + dur);
    }catch(e){}
  }

  function drawMonitor(){
    const now = performance.now();
    const dt = Math.min(0.05, (now - lastFrame)/1000);
    lastFrame = now;

    const w = monitorCanvas.width, h = monitorCanvas.height;
    const pixelsPerMm = Math.max(6, Math.round(w/160));
    const speedPxPerSec = 25 * pixelsPerMm;
    xOffset += speedPxPerSec * dt;

    monitorCtx.clearRect(0,0,w,h);

    const ecgTop = Math.floor(h*0.10), ecgH = Math.floor(h*0.40);
    const respTop = Math.floor(h*0.60), respH = Math.floor(h*0.16);
    const pressTop = Math.floor(h*0.52), pressH = Math.floor(h*0.12);

    const hrRaw = HR ?? bpm ?? 0;
    const displayHR = document.getElementById('displayHR');
    if(displayHR) displayHR.textContent = String(Math.round(hrRaw||0));
    const alarmBox = document.getElementById('alarmBox');

    // Track HR trend for sparkline
    trackHR(hrRaw);

    if (hrRaw <= 0){
      monitorCtx.save();
      const ecgI = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ecg-intensity')) || 1.0;
      monitorCtx.strokeStyle = `rgba(74,255,74,${0.8*ecgI})`;
      monitorCtx.lineWidth = Math.max(2, Math.round(h/240));
      monitorCtx.beginPath();
      monitorCtx.moveTo(0, ecgTop + ecgH*0.5);
      monitorCtx.lineTo(w, ecgTop + ecgH*0.5);
      monitorCtx.stroke();
      monitorCtx.restore();

      // Resp baseline breathing
      monitorCtx.beginPath();
      for(let i=0;i<=w;i++){
        const t = (xOffset + i) / speedPxPerSec;
        const respRate = Math.max(6, Math.min(40, RESP || 16));
        const respPeriod = 60 / respRate;
        const val = 0.5 + 0.45 * Math.sin((t / respPeriod) * 2.0 * Math.PI);
        const y = respTop + respH*(1 - val);
        if(i===0) monitorCtx.moveTo(i,y); else monitorCtx.lineTo(i,y);
      }
      const respI = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--resp-intensity')) || 1.0;
      monitorCtx.strokeStyle = `rgba(255,255,255,${0.8*respI})`; monitorCtx.lineWidth = 2; monitorCtx.stroke();

      bedBeatPeriodEl.textContent = '0.00 s';
      bedPhaseEl.textContent = '0.00 (0‚Äì1)';
      bedValvesEl.textContent = valvesMode;
      bedStatusEl.textContent = 'Stopped';

      drawSmallSignal(ekgCtx, ekgSignal, xOffset, 1.0, 'Electrical');
      drawSmallSignal(mechCtx, mechSignal, xOffset, 1.0, 'Mechanical');

      if (alarmBox){
        alarmBox.textContent = 'ALARM: NORMAL';
        alarmBox.style.borderColor = 'rgba(255,255,255,0.06)';
      }
      drawSparkline();
      updateHRBeacon(hrTier(hrRaw));
      return;
    }

    let RR = 60 / Math.max(30, Math.min(220, hrRaw));

    // Rhythm mods
    if (rhythmMode === 'irregular'){
      RR *= (1.0 + (Math.sin(now*0.002) * 0.06) + (Math.random()-0.5)*0.03);
    }
    if (arrhythmiaMode === 'afib'){
      RR *= (1.0 + (Math.random()-0.5)*0.12);
    }
    if (arrhythmiaMode === 'vtach'){
      RR *= 0.75 + (Math.random()-0.5)*0.02;
    }

    // Pacing: inject R peaks beep if missing
    if (pacingOn && ((now/1000 - lastRTime) > RR * 1.5)){
      lastRTime = now/1000;
      playBeep(1200, 0.05, 0.12);
    }

    const ecgScaleMmPerMv = 10;
    const pxPerMv = ecgScaleMmPerMv * pixelsPerMm;

    monitorCtx.save();
    monitorCtx.translate(-(xOffset % w), 0);
    monitorCtx.strokeStyle = '#4aff4a';
    monitorCtx.lineWidth = Math.max(2, Math.round(h/240));
    monitorCtx.shadowColor = 'rgba(0,255,120,0.25)';
    monitorCtx.shadowBlur = 12;
    monitorCtx.beginPath();

    const rThreshMv = 1.2;
    const refractory = 0.200;
    const samples = w;

    for(let i=0;i<=samples;i++){
      const t = (xOffset + i) / speedPxPerSec;
      const cyc = t / RR;
      const phi = cyc - Math.floor(cyc);
      const mV = ekgLeadII(phi, RR);
      const y = ecgTop + ecgH*0.5 - (mV * pxPerMv);

      if (i===0) monitorCtx.moveTo(i, y); else monitorCtx.lineTo(i, y);

      const rWindowStart = 0.17, rWindowEnd = 0.35;
      if (phi > rWindowStart && phi < rWindowEnd){
        const tSinceLastR = (t - lastRTime);
        if (mV > rThreshMv && lastV <= rThreshMv && tSinceLastR > refractory){
          lastRTime = t;
          playBeep(880, 0.08, 0.22);
        }
      }
      lastV = mV;
    }
    monitorCtx.stroke();
    monitorCtx.restore();
    monitorCtx.shadowBlur = 0;

    const tGlobal = (xOffset / speedPxPerSec);
    const beatPeriod = RR;
    const phaseRaw = (tGlobal - lastRTime) / RR;
    const phase = Math.max(0, Math.min(1, phaseRaw - Math.floor(phaseRaw)));

    bedBeatPeriodEl.textContent = beatPeriod.toFixed(2) + ' s';
    bedPhaseEl.textContent = phase.toFixed(2) + ' (0‚Äì1)';
    bedValvesEl.textContent = valvesMode;
    bedStatusEl.textContent = (HR ?? 0) > 0 ? 'Running' : 'Stopped';

    drawSmallSignal(ekgCtx, ekgSignal, xOffset, RR, 'Electrical');
    drawSmallSignal(mechCtx, mechSignal, xOffset, RR, 'Mechanical');

    if (showPressure){
      monitorCtx.beginPath();
      for(let i=0;i<=samples;i++){
        const t = (xOffset + i) / speedPxPerSec;
        const local = t - lastRTime;
        const pEnv = lvPressureEnvelope(Math.max(0, local), RR);
        const y = pressTop + pressH * (1.0 - pEnv);
        if (i===0) monitorCtx.moveTo(i,y); else monitorCtx.lineTo(i,y);
      }
      monitorCtx.strokeStyle = '#ffd27a';
      monitorCtx.lineWidth = 2;
      monitorCtx.stroke();
    }

    // Respiration
    monitorCtx.beginPath();
    for(let i=0;i<=samples;i++){
      const t = (xOffset + i) / speedPxPerSec;
      const respRate = Math.max(6, Math.min(40, RESP || 16));
      const respPeriod = 60 / respRate;
      const val = 0.5 + 0.45 * Math.sin((t / respPeriod) * 2.0 * Math.PI);
      const y = respTop + respH*(1 - val);
      if(i===0) monitorCtx.moveTo(i,y); else monitorCtx.lineTo(i,y);
    }
    monitorCtx.strokeStyle = '#ffffff'; monitorCtx.lineWidth = 2; monitorCtx.stroke();

    const lastRX = lastRTime * speedPxPerSec - xOffset;
    if (lastRX >= 0 && lastRX <= w){
      const yMid = ecgTop + ecgH*0.5;
      monitorCtx.beginPath();
      monitorCtx.arc(lastRX, yMid, 6, 0, Math.PI*2);
      monitorCtx.strokeStyle = '#ffea00';
      monitorCtx.lineWidth = 2;
      monitorCtx.stroke();
    }

    const cursorX = w - 40;
    monitorCtx.beginPath();
    monitorCtx.moveTo(cursorX, ecgTop);
    monitorCtx.lineTo(cursorX, ecgTop + ecgH);
    monitorCtx.setLineDash([6,4]);
    monitorCtx.strokeStyle = 'rgba(255,255,255,0.45)';
    monitorCtx.lineWidth = 2;
    monitorCtx.stroke();
    monitorCtx.setLineDash([]);

    if (alarmBox){
      if (hrRaw < 50 || hrRaw > 130){
        alarmBox.textContent = 'ALARM: HR OUT OF RANGE';
        alarmBox.style.borderColor = 'rgba(255,0,0,0.5)';
      } else {
        alarmBox.textContent = 'ALARM: NORMAL';
        alarmBox.style.borderColor = 'rgba(255,255,255,0.12)';
      }
    }

    drawSparkline();
    updateHRBeacon(hrTier(hrRaw));
  }

  function startMonitorLoop(){
    if (monitorRunning) return; monitorRunning = true;
    function loop(){ if (!monitorRunning) return; drawMonitor(); requestAnimationFrame(loop); }
    requestAnimationFrame(loop);
  }
  function stopMonitorLoop(){ monitorRunning = false; }

  function updateBPM(val){
    if (hrLocked) { toast('<div><strong>HR is locked</strong></div>','info',900); document.getElementById('bpmSlider').value = HR; return; }
    bpm = Number(val);
    HR = bpm;
    manualHRSet = true;
    document.getElementById('bpmValue').textContent = bpm;
    setVideoRateFromHR();
    if (!monitorRunning) startMonitorLoop();
    persistState();
  }

  function presetHR(v){
    if (hrLocked) { toast('<div><strong>HR is locked</strong></div>','info',900); return; }
    HR = v; bpm = v; manualHRSet = true;
    document.getElementById('bpmValue').textContent = v;
    document.getElementById('bpmSlider').value = v;
    setVideoRateFromHR();
    ensureVideoPlaying();
    persistState();
  }

  function applyManualInputs(){
    const hr = Number(document.getElementById('manualHR')?.value || NaN);
    const name = (document.getElementById('manualName')?.value || '').trim();
    const ageVal = document.getElementById('manualAge')?.value || '';
    const age = ageVal !== '' ? Number(ageVal) : NaN;
    const spo2 = Number(document.getElementById('manualSpO2')?.value || NaN);
    const resp = Number(document.getElementById('manualResp')?.value || NaN);
    const bpText = (document.getElementById('manualBP')?.value || '').trim();

    if (!hr || isNaN(hr) || hr < 20 || hr > 220){ alert('Please enter a valid Heart Rate (20-220)'); return; }

    HR = hr; bpm = hr; manualHRSet = true;
    document.getElementById('bpmValue').textContent = hr;
    document.getElementById('bpmSlider').value = hr;

    if (!isNaN(spo2) && spo2 > 0){
      const ds = document.getElementById('displaySpO2'); if (ds) ds.textContent = String(Math.round(spo2)) + '%';
    }
    if (!isNaN(resp) && resp > 0){ RESP = resp; }

    LAST_ANALYSIS = LAST_ANALYSIS || {};
    if (name) LAST_ANALYSIS.name = name;
    if (!isNaN(age) && isFinite(age)) LAST_ANALYSIS.age = age;
    if (bpText) {
      LAST_ANALYSIS.extra = LAST_ANALYSIS.extra || {};
      LAST_ANALYSIS.extra.bp = bpText;
    }
    LAST_ANALYSIS.reported_symptoms = suggestSymptomsFromHR(hr);
    LAST_ANALYSIS.summary_comment = (LAST_ANALYSIS.summary_comment || 'Manual vitals applied');
    LAST_ANALYSIS.average_heart_rate_bpm = hr;
    LAST_ANALYSIS.updatedAt = (new Date()).toISOString();

    setVideoRateFromHR();
    startMonitorLoop();
    updatePatientConditionPanel();
    persistState();
    closeModal('manualModal');
    toast('<div><strong>Manual vitals applied</strong></div>', 'success', 1500);
  }

  async function scanBluetooth() {
    try {
      if (!navigator.bluetooth){ toast('‚ùå Web Bluetooth is not supported', 'error', 2000); return; }
      const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: ['heart_rate','battery_service'] });
      if (!device){ toast('‚ö†Ô∏è No device selected', 'info'); return; }
      toast('<div class="spinner"></div> Connecting...', 'loading', 1600);
      const server = await device.gatt.connect();
      let hrService = null; try { hrService = await server.getPrimaryService('heart_rate'); } catch(e) { hrService = null; }
      if (!hrService){ toast('‚ö†Ô∏è Heart Rate service not found', 'info'); return; }
      const hrChar = await hrService.getCharacteristic('heart_rate_measurement');
      function parseHeartRate(dataView) {
        const flags = dataView.getUint8(0); const hr16 = flags & 0x1; let offset = 1;
        return hr16 ? dataView.getUint16(offset, true) : dataView.getUint8(offset);
      }
      const onHrChanged = (ev) => {
        const val = ev.target.value;
        const dv = val instanceof DataView ? val : new DataView(val.buffer || val);
        const hrval = parseHeartRate(dv);
        if (hrval && !isNaN(hrval)) {
          if (!hrLocked){
            HR = hrval; bpm = hrval; manualHRSet = true;
            document.getElementById('bpmValue').textContent = hrval;
            document.getElementById('bpmSlider').value = hrval;
            setVideoRateFromHR();
            if (!monitorRunning) startMonitorLoop();
            persistState();
          }
        }
      };
      await hrChar.startNotifications();
      hrChar.addEventListener('characteristicvaluechanged', onHrChanged);
      toast('‚úÖ Connected and streaming HR', 'success', 1800);
      closeModal('wearableModal');
    } catch(e) {
      toast('‚ùå Error: ' + e.message, 'error', 2200);
    }
  }

  /* Image modal */
  function openImageModal(){
    closeModal('dataSourceModal');
    const im = document.getElementById('imageModal');
    if (im) im.classList.add('active');
    document.getElementById('imgPreview').style.display='none';
    document.getElementById('imgPlaceholder').style.display='block';
    document.getElementById('imageAnalysisResult').innerHTML='No analysis yet.';
    document.getElementById('imgProgressBar').style.width='0%';
    document.getElementById('statRR').textContent='--';
    document.getElementById('statRRStd').textContent='--';
    document.getElementById('statAmp').textContent='--';
    document.getElementById('statLead').textContent='--';
  }

  document.getElementById('imageInput').addEventListener('change', function(){
    const file = this.files && this.files[0];
    const preview = document.getElementById('imgPreview'); const placeholder = document.getElementById('imgPlaceholder');
    if (!file) { if (preview) preview.style.display='none'; if (placeholder) placeholder.style.display='block'; return; }
    try{
      const url = URL.createObjectURL(file); preview.src = url; preview.style.display='block'; placeholder.style.display='none';
      animateProgress('imgProgressBar', 30);
    }catch(e){}
  });

  // Local image analyzer
  async function analyzeImage(){
    const fileEl = document.getElementById('imageInput');
    const resEl = document.getElementById('imageAnalysisResult');
    const previewEl = document.getElementById('imgPreview');
    const canvas = document.getElementById('imgCanvas');
    if (!fileEl || !fileEl.files || fileEl.files.length === 0){ resEl.innerText = 'Please choose an image file first.'; return; }
    const file = fileEl.files[0];
    animateProgress('imgProgressBar', 55);

    const img = new Image();
    img.onload = async () => {
      const w = 1024, h = Math.round((img.height / img.width) * 1024);
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      let text = '';
      try {
        const ocr = await Tesseract.recognize(canvas, 'eng', { logger: _=>{} });
        text = (ocr && ocr.data && ocr.data.text) ? ocr.data.text : '';
      } catch (e) {
        text = '';
      }

      let name = LAST_ANALYSIS?.name || 'Patient';
      const nameMatch = text.match(/name\s*[:\-]\s*([A-Za-z][A-Za-z\s\.']{1,40})/i);
      if (nameMatch && nameMatch[1]) name = nameMatch[1].trim();
      else {
        const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s);
        if (lines.length) {
          const candidate = lines.find(s => /^[A-Za-z][A-Za-z\s\.'-]{2,}$/.test(s) && s.length <= 40);
          if (candidate) name = candidate.trim();
        }
      }

      let age = LAST_ANALYSIS?.age ?? null;
      const ageMatch = text.match(/age\s*[:\-]?\s*(\d{1,3})/i) || text.match(/(\d{1,3})\s*years/i);
      if (ageMatch) {
        const av = Number(ageMatch[1]);
        if (!isNaN(av) && av > 0 && av < 150) age = av;
      }

      let rhythm = null;
      const rhythmCandidates = [
        /sinus\s+rhythm/i,
        /atrial\s+fibrillation|a[\s-]?fib/i,
        /tachycardia/i,
        /bradycardia/i,
        /normal\s+rhythm/i,
        /ventricular\s+(tachycardia|fibrillation)/i
      ];
      for (const re of rhythmCandidates) { const m = text.match(re); if (m){ rhythm = m[0]; break; } }

      let hrFromText = null;
      const hrRegexes = [
        /average\s*heart\s*rate\s*[:\-]?\s*(\d{2,3})\s*bpm/i,
        /avg\s*hr\s*[:\-]?\s*(\d{2,3})/i,
        /heart\s*rate\s*[:\-]?\s*(\d{2,3})\s*bpm/i,
        /hr\s*[:\-]?\s*(\d{2,3})\s*bpm?/i,
        /(\d{2,3})\s*bpm/i
      ];
      for (const re of hrRegexes) {
        const m = text.match(re);
        if (m){ const v = Number(m[1]); if (!isNaN(v) && v>=20 && v<=220) { hrFromText = v; break; } }
      }

      const estimate = estimateBPMFromGraph(ctx, w, h);
      let usedHR = hrFromText || estimate.estimatedBPM || 72;
      usedHR = clamp(Math.round(usedHR), 20, 220);

      const visualAnalysis = [];
      if (estimate.rrStdMs !== null && estimate.rrMs !== null) {
        const cv = estimate.rrStdMs / (estimate.rrMs || 1);
        if (cv < 0.12) visualAnalysis.push('Regular RR intervals');
        else visualAnalysis.push('Irregular RR variability');
      } else {
        visualAnalysis.push('ECG rhythm not fully clear; waveform likely single-lead.');
      }
      if (estimate.peakAmp !== null) {
        const ampDesc = estimate.peakAmp > 0.35 ? 'High QRS amplitude' : (estimate.peakAmp > 0.18 ? 'Moderate QRS amplitude' : 'Low QRS amplitude');
        visualAnalysis.push(ampDesc);
      }

      const symptoms = suggestSymptomsFromHR(usedHR);
      const displayName = name || (LOADED_CSV_PATIENTID ? LOADED_CSV_PATIENTID : 'Patient');
      const dobText = extractDOB(text) || LAST_ANALYSIS?.dob || '--';
      const summaryComment = extractSummary(text) || 'ECG overview captured from image.';

      const out = [];
      out.push(`<div><span style="color:#fff;font-weight:800">Name:</span> <span style="color:#dbeafe">${displayName}</span></div>`);
      out.push(`<div><span style="color:#94a3b8">Age:</span> <span style="color:#93c5fd">${age !== null ? age : 'Not mentioned'}</span></div>`);
      out.push(`<div><span style="color:#94a3b8">DOB:</span> <span style="color:#93c5fd">${dobText}</span></div>`);
      out.push(`<div><span style="color:#ffd700;font-weight:800">Rhythm:</span> <span style="color:#fff">${rhythm || 'Sinus rhythm (assumed)'}</span></div>`);
      out.push(`<div><span style="color:#f0abfc;font-weight:700">Summary:</span> <span style="color:#e6edf3">${summaryComment}</span></div>`);
      out.push(`<div><span style="color:#86efac;font-weight:800">Average HR:</span> <span style="color:#bbf7d0">${usedHR} bpm</span></div>`);
      out.push(`<div><span style="color:#fda4af;font-weight:700">Symptoms:</span> <span style="color:#ffccd5">${symptoms.join(', ')}</span></div>`);
      out.push(`<div style="margin-top:6px;color:#fff;font-size:12px;"><strong>Visual analysis:</strong> ${visualAnalysis.join('; ')}</div>`);
      resEl.innerHTML = out.join('');

      // mini stats
      document.getElementById('statRR').textContent = estimate.rrMs !== null ? Math.round(estimate.rrMs) : '--';
      document.getElementById('statRRStd').textContent = estimate.rrStdMs !== null ? Math.round(estimate.rrStdMs) : '--';
      document.getElementById('statAmp').textContent = estimate.peakAmp !== null ? (estimate.peakAmp.toFixed(2)) : '--';
      document.getElementById('statLead').textContent = '--';

      LAST_ANALYSIS = {
        name: displayName,
        age: age !== null ? age : undefined,
        dob: dobText !== '--' ? dobText : undefined,
        rhythm: rhythm || 'Sinus rhythm',
        summary_comment: summaryComment,
        average_heart_rate_bpm: usedHR,
        reported_symptoms: symptoms,
        mechanical_amplitude_estimate: estimate.peakAmp !== null ? Math.round(estimate.peakAmp * 100) : 30,
        graph_observations: visualAnalysis.join('; '),
        updatedAt: new Date().toISOString(),
        extra: LAST_ANALYSIS?.extra || {}
      };

      updatePatientConditionPanel();

      // Pre-set HR for preview
      if (!hrLocked){
        HR = usedHR; bpm = usedHR; manualHRSet = true;
        document.getElementById('bpmValue').textContent = usedHR;
        document.getElementById('bpmSlider').value = usedHR;
      }
      animateProgress('imgProgressBar', 100);
      persistState();
    };
    img.onerror = () => { resEl.innerText = 'Could not load image.'; };
    img.src = URL.createObjectURL(file);
    previewEl.style.display = 'block';
    document.getElementById('imgPlaceholder').style.display = 'none';
  }

  function extractDOB(text){
    const m = text.match(/(\d{1,2}[\s\/\-][A-Za-z]{3,9}[\s\/\-]\d{2,4})|([A-Za-z]{3,9}\s+\d{1,2},\s*\d{4})|(\d{1,2}[\-\/]\d{1,2}[\-\/]\d{2,4})/);
    return m ? m[0] : null;
  }
  function extractSummary(text){
    const m = text.match(/summary\s*[:\-]\s*(.+)/i) || text.match(/comment\s*[:\-]\s*(.+)/i);
    if (m) return m[1].trim().slice(0, 200);
    return null;
  }
  function suggestSymptomsFromHR(hr){
    const s = [];
    if (hr < 50) s.push('Fatigue','Dizziness');
    else if (hr < 60) s.push('Mild fatigue');
    else if (hr <= 100) s.push('Stable');
    else if (hr <= 130) s.push('Palpitations','Shortness of breath (on exertion)');
    else s.push('Severe palpitations','Chest discomfort');
    return s;
  }

  function estimateBPMFromGraph(ctx, w, h){
    try{
      const imgData = ctx.getImageData(0, 0, w, h);
      const buf = imgData.data;
      const gray = new Float32Array(w*h);
      for (let i=0;i<buf.length;i+=4){
        const r=buf[i], g=buf[i+1], b=buf[i+2];
        gray[i/4] = (0.299*r+0.587*g+0.114*b)/255;
      }
      const y0 = Math.floor(h*0.30), y1 = Math.floor(h*0.70);
      const sigLen = w;
      const signal = new Float32Array(sigLen);
      for (let x=0;x<w;x++){
        let s=0, c=0;
        for (let y=y0;y<y1;y++){ s += gray[y*w+x]; c++; }
        signal[x] = s/(c||1);
      }
      let min=Infinity, max=-Infinity;
      for (let i=0;i<sigLen;i++){ if (signal[i]<min) min=signal[i]; if (signal[i]>max) max=signal[i]; }
      const norm = new Float32Array(sigLen);
      for (let i=0;i<sigLen;i++){ norm[i] = 1 - ((signal[i]-min)/((max-min)||1)); }

      const sm = smooth(norm, 5);
      const thr = percentile(sm, 92);
      const peaks = [];
      const refractory = Math.floor(w*0.01);
      for (let i=1;i<sigLen-1;i++){
        if (sm[i] > thr && sm[i] > sm[i-1] && sm[i] > sm[i+1]){
          if (!peaks.length || (i - peaks[peaks.length-1]) > refractory) peaks.push(i);
        }
      }
      if (peaks.length < 3){
        return { estimatedBPM: 72, rrMs: null, rrStdMs: null, peakAmp: null, leadGuess: null };
      }
      const rrsPx = [];
      for (let i=1;i<peaks.length;i++) rrsPx.push(peaks[i]-peaks[i-1]);
      const rrAvgPx = mean(rrsPx), rrStdPx = std(rrsPx);
      const mmPx = estimateMinorGridPx(gray, w, h) || (w/160);
      const mmPerSec = 25;
      const secPerPx = (1/mmPerSec) / mmPx;
      const rrSec = rrAvgPx * secPerPx;
      const bpmEst = 60 / (rrSec || (60/72));

      let peakAmp = 0;
      for (let i=0;i<peaks.length;i++){ peakAmp += sm[peaks[i]]; }
      peakAmp = peakAmp / peaks.length;
      peakAmp = clamp((peakAmp - percentile(sm, 50)) / (percentile(sm, 99) - percentile(sm, 50) || 1), 0, 1);

      const leadGuess = null;

      return {
        estimatedBPM: clamp(Math.round(bpmEst), 30, 200),
        rrMs: rrSec*1000,
        rrStdMs: rrStdPx*secPerPx*1000,
        peakAmp,
        leadGuess
      };
    }catch(e){
      return { estimatedBPM: 72, rrMs: null, rrStdMs: null, peakAmp: null, leadGuess: null };
    }
  }
  function smooth(arr, win){
    const out = new Float32Array(arr.length);
    const half = Math.max(1, Math.floor(win/2));
    for (let i=0;i<arr.length;i++){
      let s=0,c=0;
      for (let k=-half;k<=half;k++){
        const j=i+k; if (j>=0 && j<arr.length){ s+=arr[j]; c++; }
      }
      out[i]=s/(c||1);
    }
    return out;
  }
  function percentile(arr, p){
    const a = Array.from(arr).sort((x,y)=>x-y);
    const idx = Math.floor((p/100)*a.length);
    return a[clamp(idx,0,a.length-1)];
  }
  function mean(a){ return a.reduce((s,v)=>s+v,0)/(a.length||1); }
  function std(a){ const m=mean(a); return Math.sqrt(a.reduce((s,v)=>s+(v-m)*(v-m),0)/(a.length||1)); }
  function estimateMinorGridPx(gray, w, h){
    const colSum = new Float32Array(w);
    for (let x=0;x<w;x++){
      let s=0;
      for (let y=1;y<h;y++){
        const d = Math.abs(gray[y*w+x] - gray[(y-1)*w+x]);
        s += d;
      }
      colSum[x] = s;
    }
    let bestLag=0, bestVal=0;
    const maxLag = Math.min(60, Math.floor(w/10));
    for (let lag=4;lag<=maxLag;lag++){
      let s=0;
      for (let i=0;i<w-lag;i++){ s += colSum[i]*colSum[i+lag]; }
      if (s > bestVal){ bestVal=s; bestLag=lag; }
    }
    return bestLag || null;
  }

  // Apply image after success confirmation
  

  // *** FIR FILTER: Update from image analysis ***
  function updateFIRFromImage(analysis) {
    const hrVal = analysis.hr || 72;
    const rrAvg = analysis.rr_avg || 833;
    const sampleRate = 500;
    const duration = 3;
    const numSamples = sampleRate * duration;
    const ecgData = [];

    for (let i = 0; i < numSamples; i++) {
      const t = i / sampleRate;
      const beatPeriod = rrAvg / 1000;
      const phase = (t % beatPeriod) / beatPeriod;

      let signal = 0;
      signal += 0.12 * Math.exp(-Math.pow((phase - 0.18), 2) / 0.006);

      const qrsAmp = (analysis.qrs_amp || 1.0);
      signal += qrsAmp * Math.exp(-Math.pow((phase - 0.30), 2) / 0.001);
      signal -= 0.16 * qrsAmp * Math.exp(-Math.pow((phase - 0.28), 2) / 0.0008);
      signal -= 0.25 * qrsAmp * Math.exp(-Math.pow((phase - 0.32), 2) / 0.0008);

      signal += 0.20 * Math.exp(-Math.pow((phase - 0.62), 2) / 0.04);
      signal += (Math.random() - 0.5) * 0.03;

      ecgData.push(signal * 50);
    }

    imageDataForFIR = ecgData;
    console.log('Image ECG data prepared for FIR filter:', ecgData.length, 'samples');
  }

function applyImageDataConfirmed(){
    toast('<div><strong>Applied successfully</strong></div>', 'success', 900);
    setTimeout(()=>{ applyImageData(); }, 950);
  }
  function applyImageData(){
    setVideoRateFromHR();
    startMonitorLoop();
    if (LAST_ANALYSIS){
      if (LAST_ANALYSIS.mechanical_amplitude_estimate){
        const s = Number(LAST_ANALYSIS.mechanical_amplitude_estimate);
        if (!isNaN(s) && isFinite(s)){ mechScale = clamp(s/30, 0, 3); }
      }
      if (LAST_ANALYSIS.average_heart_rate_bpm && !hrLocked){
        HR = Number(LAST_ANALYSIS.average_heart_rate_bpm);
        bpm = HR;
        document.getElementById('bpmValue').textContent = HR;
        document.getElementById('bpmSlider').value = HR;
      }
      if (Array.isArray(LAST_ANALYSIS.reported_symptoms) && LAST_ANALYSIS.reported_symptoms.length){
        document.getElementById('patient-symptoms').innerText = LAST_ANALYSIS.reported_symptoms.join(', ');
      } else {
        document.getElementById('patient-symptoms').innerText = 'Stable';
      }
      updatePatientConditionPanel();
      
    if (typeof updateFIRFromImage === "function") updateFIRFromImage(r);
    persistState();
    }
  }

  /* HR tier */
  function hrTier(hr){
    if (hr <= 0) return 'stopped';
    if (hr < 50) return 'brady';
    if (hr <= 100) return 'normal';
    if (hr <= 130) return 'tachy';
    return 'high_tachy';
  }

  /* Single beacon logic */
  function updateHRBeacon(tier){
    const beacon = document.getElementById('hrBeacon');
    if (!beacon) return;
    beacon.classList.remove('beacon-yellow','beacon-red');
    // High: red, Normal/Low: yellow; Stopped: yellow (soft)
    if (tier === 'high_tachy' || tier === 'tachy') beacon.classList.add('beacon-red');
    else beacon.classList.add('beacon-yellow');
  }

  function addAdviceRow(grid, badgeClass, title, note){
    const row = document.createElement('div');
    row.className = 'advice-item';
    const badge = document.createElement('div');
    badge.className = 'advice-badge ' + badgeClass;
    badge.textContent = '‚Ä¢';
    const text = document.createElement('div');
    text.className = 'advice-text';
    text.innerHTML = `<div class="advice-title">${title}</div><div class="advice-note">${note}</div>`;
    row.appendChild(badge); row.appendChild(text);
    grid.appendChild(row);
  }

  function generateAdviceListStrict(tier){
    const items = [];
    if (tier === 'stopped'){
      items.push({c:'badge-yellow', t:'Connect input', n:'Attach wearable, upload CSV, or set manual BPM to resume monitoring.'});
      items.push({c:'badge-green', t:'Relaxed breathing', n:'Use gentle diaphragmatic breathing to stay calm.'});
      return items;
    }
    if (tier === 'brady'){
      const dos = [
        'Warm up slowly before activity.',
        'Hydrate consistently through the day.',
        'Notice dizziness, fatigue, or lightheadedness.',
        'Prefer smaller, frequent meals.',
        'Take regular breaks during exertion.',
        'Practice slow, deep nasal breathing.',
        'Prioritize 7‚Äì8 hours sleep.',
        'Keep caffeine modest.',
        'Log HR trend daily.',
        'Discuss persistent symptoms with a clinician.'
      ];
      const donts = [
        'Do not jump into intense workouts.',
        'Do not skip hydration after activity.',
        'Do not ignore chest discomfort.',
        'Do not use sedatives without guidance.',
        'Do not drive if dizzy.',
        'Do not exceed alcohol limits.',
        'Do not overlook persistent fatigue.',
        'Do not rely only on gadgets‚Äîtrack symptoms.',
        'Do not combine stimulants impulsively.',
        'Do not delay care if symptoms worsen.'
      ];
      dos.forEach(s=>items.push({c:'badge-green', t:'Do', n:s}));
      donts.forEach(s=>items.push({c:'badge-yellow', t:'Do not', n:s}));
      return items;
    }
    if (tier === 'normal'){
      const dos = [
        'Maintain moderate exercise (~150 min/week).',
        'Use interval breaks for long sessions.',
        'Hydrate, add electrolytes when sweating.',
        'Choose balanced, fiber-rich meals.',
        'Keep sodium and added sugars in check.',
        'Practice stress management / mindfulness.',
        'Prioritize sleep quality (7‚Äì8 hours).',
        'Monitor weekly HR trend.',
        'Include warm-up and cool-down.',
        'Keep caffeine to moderate levels.'
      ];
      const donts = [
        'Do not ramp intensity without warm-up.',
        'Do not ignore new palpitations.',
        'Do not overtrain consecutive days.',
        'Do not neglect recovery time.',
        'Do not rely on energy drinks.',
        'Do not skip cool-down.',
        'Do not dismiss large HR spikes.',
        'Do not forget hydration in heat.',
        'Do not use alcohol for relaxation.',
        'Do not skip periodic health checks.'
      ];
      dos.forEach(s=>items.push({c:'badge-green', t:'Do', n:s}));
      donts.forEach(s=>items.push({c:'badge-yellow', t:'Do not', n:s}));
      return items;
    }
    // Tachy / High tachy
    const dos = [
      'Pause strenuous activity immediately.',
      'Switch to gentle movement and cool-down.',
      'Hydrate with cool water in shade/ventilated area.',
      'Review stimulants (caffeine, nicotine).',
      'Use slow nasal breathing (4‚Äì6 breaths/min).',
      'Identify triggers: heat, dehydration, stress, illness.',
      'Prefer smaller efforts with recovery gaps.',
      'Note chest discomfort or breathlessness promptly.',
      'Seek clinical guidance if episodes recur.',
      'Log HR trend to capture persistence.'
    ];
    const donts = [
      'Do not continue high-intensity exercise.',
      'Do not overuse caffeine or energy drinks.',
      'Do not ignore severe symptoms.',
      'Do not stay in very hot environments.',
      'Do not skip hydration.',
      'Do not combine stimulants.',
      'Do not delay rest when HR is elevated.',
      'Do not self-medicate without medical advice.',
      'Do not drive if dizzy or faint.',
      'Do not dismiss repeated tachy episodes.'
    ];
    dos.forEach(s=>items.push({c:'badge-orange', t:'Do', n:s}));
    donts.forEach(s=>items.push({c:'badge-red', t:'Do not', n:s}));
    return items;
  }

  function generateAIDoctorAdvice(){
    const panel = document.getElementById('aiAdvicePanel');
    const out = document.getElementById('aiAdviceContent');
    const hr = Math.round(HR ?? bpm ?? 0);

    const tier = hrTier(hr);
    const header = document.createElement('div');
    header.style.marginBottom = '8px';
    header.style.fontWeight = '900';

    // Requested: critical/normal/low
    let statusText = 'Normal';
    let color = '#4ade80';
    if (tier === 'brady'){ statusText = 'Low'; color = '#fbbf24'; }
    else if (tier === 'tachy' || tier === 'high_tachy'){ statusText = 'Critical'; color = '#ef4444'; }
    else if (tier === 'stopped'){ statusText = 'No data'; color = '#9aa'; }

    header.textContent = `Overall: ${statusText} heart rate status`;
    header.style.color = color;

    const grid = document.createElement('div');
    grid.className = 'advice-grid';

    // Strictly 20 lines total (mix do/don't), without recommending specific medications
    const items = generateAdviceListStrict(tier);
    const maxLines = 20;
    for (let i=0;i<Math.min(items.length, maxLines); i++){
      addAdviceRow(grid, items[i].c, items[i].t, items[i].n);
    }

    out.innerHTML = '';
    out.appendChild(header);
    out.appendChild(grid);
    panel.style.display = 'block';
  }

  // Compact patient line replaces capital name + adds live metrics
  function updatePatientConditionPanel(){
    const nameEl = document.getElementById('patient-name');
    const symptomsEl = document.getElementById('patient-symptoms');
    const upEl = document.getElementById('patient-updated');

    let pname = '--', psym = '--', updatedText = '--';
    const hrDisp = Math.round(HR || bpm || 0);
    const spo2Text = document.getElementById('displaySpO2')?.textContent || '--';
    const respText = (RESP || '--') + ' bpm';

    if (LAST_ANALYSIS){
      const rawName = LAST_ANALYSIS.name || 'Patient';
      const ageText = LAST_ANALYSIS?.age ?? '--';
      const dobText = LAST_ANALYSIS?.dob ?? '--';
      const bp = LAST_ANALYSIS?.extra?.bp ?? '--';
      const chol = LAST_ANALYSIS?.extra?.chol ?? '--';

      // Compact replacement line
      pname = `${rawName} ‚Ä¢ Age: ${ageText} ‚Ä¢ DOB: ${dobText} ‚Ä¢ BP: ${bp} ‚Ä¢ Chol: ${chol} ‚Ä¢ HR: ${hrDisp} ‚Ä¢ SpO2: ${spo2Text} ‚Ä¢ Resp: ${respText}`;

      if (Array.isArray(LAST_ANALYSIS.reported_symptoms) && LAST_ANALYSIS.reported_symptoms.length) {
        psym = LAST_ANALYSIS.reported_symptoms.join(', ');
      } else if (LAST_ANALYSIS.summary_comment) {
        psym = LAST_ANALYSIS.summary_comment;
      }

      updatedText = LAST_ANALYSIS.updatedAt ? ('Recorded: ' + (new Date(LAST_ANALYSIS.updatedAt)).toLocaleString()) : '--';
    } else {
      pname = `Patient ‚Ä¢ HR: ${hrDisp} ‚Ä¢ SpO2: ${spo2Text} ‚Ä¢ Resp: ${respText}`;
      psym = 'Stable';
      updatedText = '--';
    }

    if (nameEl) nameEl.textContent = pname;
    if (upEl) upEl.textContent = updatedText;
    if (symptomsEl) symptomsEl.innerHTML = `<strong style="color:rgba(255,255,255,0.9);">Symptom:</strong> <span style="color:#ff5b5b;margin-left:6px;">${psym}</span>`;
    const warnEl = document.getElementById('patient-warnings');
    if (warnEl){ warnEl.style.display='none'; warnEl.innerHTML=''; }
  }

  function resetMonitorSoft(){
    bpm = HR;
    document.getElementById('displayHR').textContent = String(Math.round(HR||0));
    stopMonitorLoop();
    startMonitorLoop();
    hrHistory.length = 0;
    drawSparkline();
    trendBadge.textContent='Stable';
    rrVarBadge.textContent='--';
    toast('<div><strong>Monitor reset</strong></div>', 'info', 1200);
    persistState();
  }

  function resetMonitor(){
    bpm = 0; HR = 0; manualHRSet = false; RESP = 16;
    mechScale = 0;
    arrhythmiaMode = null;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.getElementById('displayHR').textContent = '0';
    document.getElementById('displaySpO2').textContent = '0%';
    document.getElementById('aiAdviceContent').innerHTML = '';
    document.getElementById('aiAdvicePanel').style.display = 'none';
    stopMonitorLoop();
    startMonitorLoop();
    LAST_ANALYSIS = null;
    document.getElementById('patient-name').textContent = '--';
    document.getElementById('patient-symptoms').textContent = '--';
    document.getElementById('patient-updated').textContent = '--';
    document.getElementById('bpmValue').textContent = 0;
    document.getElementById('bpmSlider').value = 0;
    bedBeatPeriodEl.textContent = '0.00 s';
    bedPhaseEl.textContent = '0.00 (0‚Äì1)';
    bedValvesEl.textContent = 'Auto';
    bedStatusEl.textContent = 'Stopped';
    document.getElementById('valveMode').textContent = 'Auto';
    valvesMode = 'Auto';
    pacingOn = false;
    document.getElementById('pacingMode').textContent = 'Off';
    rhythmMode = 'regular';
    document.getElementById('overlayRhythm').textContent = 'Rhythm: Sinus';
    updateHRBeacon('stopped');

    if (heartVideo){ try{ heartVideo.pause(); heartVideo.currentTime = 0; heartVideo.playbackRate = 0; } catch(e){} }

    hrHistory.length = 0;
    drawSparkline();
    trendBadge.textContent='Stable';
    rrVarBadge.textContent='--';

    try { localStorage.removeItem(STORAGE_STATE_KEY); localStorage.removeItem(STORAGE_CONTEXT_KEY); } catch(e){}
    toast('<div><strong>Full reset complete</strong></div>', 'info', 1200);
  }

  function openAnalysisModal(){
    if (data.length === 0) { alert('Load data first'); return; }
    document.getElementById('analysisModal').classList.add('active');
    setTimeout(()=>{ genCharts(); genAnalysis(); }, 100);
  }
  function genCharts() {
    const rc = document.getElementById('riskChart').getContext('2d');
    const fc = document.getElementById('flowChart').getContext('2d');
    const cats = ['Low (0-30%)','Moderate (30-50%)','High (50-75%)','Critical (75-100%)'];
    const cnts = [
      risks.filter(r => r < 0.30).length,
      risks.filter(r => r >= 0.30 && r < 0.50).length,
      risks.filter(r => r >= 0.50 && r < 0.75).length,
      risks.filter(r => r >= 0.75).length
    ];
    if (charts.risk) charts.risk.destroy();
    charts.risk = new Chart(rc, {
      type: 'bar',
      data: { labels: cats, datasets: [{ data: cnts, backgroundColor: ['#4ade80','#fbbf24','#f59e0b','#ef4444'], borderColor: '#fff', borderWidth: 2 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#fff' }, grid: { display: false } } } }
    });
    const persons = Array.from({length: data.length}, (_, i) => 'P' + (i+1));
    const riskVals = risks.map(r => (r * 100).toFixed(1));
    if (charts.flow) charts.flow.destroy();
    charts.flow = new Chart(fc, {
      type: 'line',
      data: { labels: persons, datasets: [{ data: riskVals, borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 5, pointBackgroundColor: riskVals.map((v, i) => { const r = risks[i]; return r < 0.30 ? '#4ade80' : r < 0.50 ? '#fbbf24' : r < 0.75 ? '#f59e0b' : '#ef4444'; }), pointBorderColor: '#fff', pointBorderWidth: 2 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#fff' } } }, scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#fff' }, grid: { display: false } } } }
    });
  }

  function getRisk(r){
    if (r < 0.30) return { n: 'Low', e: '‚úÖ', c: '#4ade80', cl: 'risk-low' };
    if (r < 0.50) return { n: 'Moderate', e: '‚ö†Ô∏è', c: '#fbbf24', cl: 'risk-moderate' };
    if (r < 0.75) return { n: 'High', e: 'üî∂', c: '#f59e0b', cl: 'risk-high' };
    return { n: 'Critical', e: 'üö®', c: '#ef4444', cl: 'risk-critical' };
  }

  function genAnalysis() {
    if (!data.length) return;
    const p = data[idx]; const r = risks[idx]; const cat = getRisk(r);
    document.getElementById('modalPerson').textContent = idx + 1;
    document.getElementById('modalInfo').innerHTML = `Age: ${p.age} | Sex: ${p.sex === 1 ? 'Male' : 'Female'} | Max HR: ${p.thalach} bpm`;
    document.getElementById('modalRisk').textContent = (r * 100).toFixed(1) + '%';
    let catHtml = `<div class="risk-category ${cat.cl}" style="font-weight:900;color:${cat.c};">${cat.e} ${cat.n}</div>`;
    if (cat.n === 'Low') catHtml += '<p>Low cardiovascular risk for this dataset row.</p>';
    else if (cat.n === 'Moderate') catHtml += '<p>Moderate risk ‚Äî regular monitoring recommended.</p>';
    else if (cat.n === 'High') catHtml += '<p>High risk ‚Äî prioritize consultation.</p>';
    else catHtml += '<p>Critical risk ‚Äî emergency attention may be needed.</p>';
    document.getElementById('modalCat').innerHTML = catHtml;
    document.getElementById('modalBP').textContent = (p.trestbps ?? '--') + ' mmHg';
    document.getElementById('modalChol').textContent = (p.chol ?? '--') + ' mg/dL';
    document.getElementById('modalMaxHR').textContent = (p.thalach ?? '--') + ' bpm';
    document.getElementById('modalST').textContent = p.oldpeak ?? '--';
    let tableHtml = '';
    for (let i = 0; i < data.length; i++) {
      const pd = data[i]; const rd = risks[i]; const cd = getRisk(rd);
      tableHtml += `<tr><td>${i + 1}</td><td>${pd.age}</td><td>${pd.trestbps}</td><td>${pd.chol}</td><td>${pd.thalach}</td><td style="color:${cd.c};font-weight:700;">${(rd * 100).toFixed(1)}%</td><td>${cd.e} ${cd.n}</td></tr>`;
    }
    document.getElementById('flowTable').innerHTML = tableHtml;

    // Simple info (no medication advice)
    const recEl = document.getElementById('modalRec');
    const hr = HR || p.thalach || 72;
    const tier = hrTier(hr);
    let rec = '';
    if (tier === 'brady') rec = 'Keep activity light, hydrate, and monitor symptoms. If persistent dizziness occurs, consider consultation.';
    else if (tier === 'normal') rec = 'Maintain routine exercise and regular hydration. Track your HR trend weekly.';
    else if (tier === 'tachy') rec = 'Reduce intensity, cool down properly, hydrate, and review stimulant intake.';
    else if (tier === 'high_tachy') rec = 'Stop strenuous activity, hydrate, and seek clinical advice if symptoms persist or worsen.';
    else rec = 'No HR data. Connect a source or set BPM.';
    recEl.textContent = rec;
  }

  function openDataSourceModal() { document.getElementById('dataSourceModal').classList.add('active'); }
  function openWearableModalAuto() { closeModal('dataSourceModal'); const wm = document.getElementById('wearableModal'); if (wm) { wm.classList.add('active'); } }
  function openManualModal() { closeModal('dataSourceModal'); const mm = document.getElementById('manualModal'); if (mm) mm.classList.add('active'); }
  function openOptionsModal(){ document.getElementById('optionsModal').classList.add('active'); }
  function showHardwareComingSoon() { closeModal('dataSourceModal'); document.getElementById('hardwareModal').classList.add('active'); }
  function openCsvModal(){ closeModal('dataSourceModal'); document.getElementById('csvModal').classList.add('active'); }

  // CSV handling
  function initCsvDrop(){
    const drop = document.getElementById('csvDrop');
    if (!drop) return;
    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', async (e)=>{
      e.preventDefault();
      drop.classList.remove('drag');
      const file = e.dataTransfer.files?.[0];
      if (!file) return;
      document.getElementById('csvUploadResult').textContent = 'Reading dropped file...';
      const text = await file.text();
      await loadCsvText(text);
    });
  }

  async function uploadCsvLocal(){
    const fileEl = document.getElementById('csvInput');
    const outEl = document.getElementById('csvUploadResult');
    outEl.innerText = '';
    if (!fileEl || !fileEl.files || fileEl.files.length === 0){ outEl.textContent = 'Choose CSV file first.'; return; }
    try{
      const text = await fileEl.files[0].text();
      await loadCsvText(text);
    }catch(e){
      outEl.textContent = 'Load error: ' + e.message;
    }
  }

  async function loadCsvText(text){
    const outEl = document.getElementById('csvUploadResult');
    const rows = parseCSV(text);
    if (!rows.length){ outEl.textContent = 'No rows found in CSV'; return; }
    data = rows;
    risks = data.map(r => {
      const chol = Number(r.chol||0), bp = Number(r.trestbps||0), age = Number(r.age||0);
      const score = (chol/300)*0.5 + (bp/180)*0.3 + (age/80)*0.2;
      return clamp(score, 0.05, 0.95);
    });
    LOADED_CSV_PATIENTID = (document.getElementById('csvPatientId').value||'').trim() || 'patient_123';
    LAST_ANALYSIS = LAST_ANALYSIS || {};
    LAST_ANALYSIS.name = LOADED_CSV_PATIENTID;
    LAST_ANALYSIS.updatedAt = (new Date()).toISOString();
    updatePatientConditionPanel();
    genCharts();
    outEl.textContent = 'Loaded ' + rows.length + ' records locally.';
    toast('<div><strong>CSV loaded</strong></div>', 'success', 1200);
    persistState();
  }

  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
    if (!lines.length) return [];
    const header = lines[0].split(',').map(h=>h.trim());
    const rows = [];
    for (let i=1;i<lines.length;i++){
      const parts = splitCSVLine(lines[i]);
      if (!parts.length) continue;
      const obj = {};
      for (let j=0;j<header.length;j++){
        obj[header[j]] = parts[j] !== undefined ? parseValue(parts[j]) : null;
      }
      rows.push(obj);
    }
    return rows;
  }
  function splitCSVLine(line){
    const res=[]; let cur=''; let inQ=false;
    for (let i=0;i<line.length;i++){
      const c=line[i];
      if (c==='\"'){ inQ=!inQ; continue; }
      if (!inQ && c===','){ res.push(cur.trim()); cur=''; continue; }
      cur+=c;
    }
    res.push(cur.trim());
    return res;
  }
  function parseValue(v){
    if (v===null || v===undefined) return null;
    const n = Number(v);
    return isNaN(n) ? v : n;
  }

  function applyCsvData(){
    if (!data || !Array.isArray(data) || data.length === 0){ alert('No dataset loaded.'); return; }
    const sel = document.getElementById('csvPlaybackSel');
    const delay = Number(sel?.value || 10);
    startCsvPlayback(delay);
    closeModal('csvModal');
    toast('<div><strong>CSV playback started</strong> ('+delay+'s per person)</div>', 'info', 1600);
    persistState();
  }

  function stopCsvPlayback(){
    if (csvPlaybackTimer){ clearInterval(csvPlaybackTimer); csvPlaybackTimer = null; csvPlaybackIndex = 0; }
  }

  function startCsvPlayback(delaySeconds){
    stopCsvPlayback();
    if (!data || !Array.isArray(data) || data.length === 0) return;
    csvPlaybackIndex = 0;
    applyCsvRow(csvPlaybackIndex);
    csvPlaybackIndex++;
    csvPlaybackTimer = setInterval(()=>{
      if (csvPlaybackIndex >= data.length){ stopCsvPlayback(); toast('<div><strong>CSV playback finished</strong></div>', 'success', 1400); return; }
      applyCsvRow(csvPlaybackIndex);
      csvPlaybackIndex++;
    }, (delaySeconds||10) * 1000);
  }

  function applyCsvRow(idx){
    if (!data || !Array.isArray(data) || data.length === 0) return;
    const row = data[idx];
    if (!row) return;
    let hrVal = Number(row.heartrate || row.heart_rate || row.hr || row.pulse || row.thalach || 0);
    if (!hrVal || isNaN(hrVal)) hrVal = 72;

    if (!hrLocked){
      HR = hrVal; bpm = hrVal; manualHRSet = true;
      document.getElementById('bpmValue').textContent = HR;
      document.getElementById('bpmSlider').value = HR;
      setVideoRateFromHR();
      ensureVideoPlaying();
    }

    const amp = clamp(((Number(row.trestbps||120)-90)/60) + ((Number(row.chol||200)-150)/250), 0, 3);
    mechScale = amp;

    LAST_ANALYSIS = LAST_ANALYSIS || {};
    LAST_ANALYSIS.name = (row.name || LAST_ANALYSIS.name || LOADED_CSV_PATIENTID || 'Patient');
    LAST_ANALYSIS.updatedAt = (new Date()).toISOString();
    LAST_ANALYSIS.reported_symptoms = suggestSymptomsFromHR(HR);
    LAST_ANALYSIS.summary_comment = 'CSV playback entry';
    LAST_ANALYSIS.extra = { bp: row.trestbps, chol: row.chol, hr: HR };

    updatePatientConditionPanel();
    persistState();
    if (typeof updateFIRFromCSV === "function") updateFIRFromCSV(row, hrVal);
  }

  // HR trend utilities
  

  // *** FIR FILTER: Auto-update from CSV data ***
  function updateFIRFromCSV(row, hrVal) {
    const sampleRate = 500;
    const duration = 2;
    const numSamples = sampleRate * duration;
    const ecgData = [];

    for (let i = 0; i < numSamples; i++) {
      const t = i / sampleRate;
      const beatPeriod = 60 / Math.max(30, hrVal);
      const phase = (t % beatPeriod) / beatPeriod;

      let signal = 0;
      signal += 0.1 * Math.exp(-Math.pow((phase - 0.2), 2) / 0.005);
      signal += 1.0 * Math.exp(-Math.pow((phase - 0.4), 2) / 0.001);
      signal -= 0.3 * Math.exp(-Math.pow((phase - 0.38), 2) / 0.0005);
      signal -= 0.3 * Math.exp(-Math.pow((phase - 0.42), 2) / 0.0005);
      signal += 0.3 * Math.exp(-Math.pow((phase - 0.65), 2) / 0.01);

      const bp = Number(row.trestbps || 120);
      const chol = Number(row.chol || 200);
      const baselineShift = (bp - 120) / 1000;
      const noiseLevel = (chol - 200) / 10000;
      signal += baselineShift + (Math.random() - 0.5) * noiseLevel * 0.1;

      ecgData.push(signal * 50);
    }

    csvDataForFIR = ecgData;

    if (document.getElementById('firFilterModal') && document.getElementById('firFilterModal').classList.contains('active')) {
      originalECGData = csvDataForFIR.slice();
      drawOriginalSignal();
      if (firFilterActive) {
        applyFIRFilter();
      }
    }
  }

function trackHR(hr){
    const now = performance.now();
    if (now - lastTrendUpdate > 1000){
      lastTrendUpdate = now;
      hrHistory.push({ t: Date.now(), hr: Math.max(0, Math.round(hr||0)) });
      if (hrHistory.length > 60) hrHistory.shift();
      drawSparkline();
      updateTrendLabel();
      persistState();
    }
  }

  function drawSparkline(){
    const w = hrSpark.width, h = hrSpark.height;
    hrSparkCtx.clearRect(0,0,w,h);
    if (hrHistory.length < 2) return;
    const hrs = hrHistory.map(p=>p.hr);
    const minHR = Math.max(0, Math.min(...hrs));
    const maxHR = Math.max(...hrs);
    const range = Math.max(1, maxHR - minHR);

    const sm = sparkSmooth > 0 ? smoothArray(hrHistory.map(p=>p.hr), sparkSmooth) : hrHistory.map(p=>p.hr);

    hrSparkCtx.beginPath();
    for (let i=0;i<sm.length;i++){
      const x = (i/(sm.length-1)) * (w-6) + 3;
      const y = h - ((sm[i] - minHR)/range) * (h-6) - 3;
      if (i===0) hrSparkCtx.moveTo(x,y); else hrSparkCtx.lineTo(x,y);
    }
    hrSparkCtx.strokeStyle = '#4ade80';
    hrSparkCtx.lineWidth = 2;
    hrSparkCtx.stroke();
  }
  function smoothArray(arr, win){
    const out = [];
    const half = Math.max(1, Math.floor(win/2));
    for (let i=0;i<arr.length;i++){
      let s=0,c=0;
      for (let k=-half;k<=half;k++){
        const j=i+k; if (j>=0 && j<arr.length){ s+=arr[j]; c++; }
      }
      out.push(s/(c||1));
    }
    return out;
  }
  function updateTrendLabel(){
    if (!hrTrendLabel) return;
    if (hrHistory.length < 4){ hrTrendLabel.textContent = '--'; trendBadge.textContent='--'; rrVarBadge.textContent='--'; return; }
    const last = hrHistory.slice(-6);
    const delta = last[last.length-1].hr - last[0].hr;
    hrTrendLabel.textContent = (delta>0?'+':'') + delta + ' bpm';
    trendBadge.textContent = delta>0 ? 'Rising' : (delta<0 ? 'Falling' : 'Stable');
    const range = Math.max(...last.map(p=>p.hr)) - Math.min(...last.map(p=>p.hr));
    rrVarBadge.textContent = range + ' bpm';
  }

  function downloadHR(){
    let csv = 'timestamp,hr\n';
    for (const p of hrHistory){ csv += `${new Date(p.t).toISOString()},${p.hr}\n`; }
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'hr_trend.csv'; a.click();
    URL.revokeObjectURL(url);
    toast('<div><strong>HR trend exported</strong></div>', 'success', 1200);
  }

  // Options controls
  function setGridBright(v){
    document.documentElement.style.setProperty('--grid-bright', String(v));
    drawGrid();
    persistState();
  }
  function setECGIntensity(v){
    document.documentElement.style.setProperty('--ecg-intensity', String(v));
    persistState();
  }
  function setRespIntensity(v){
    document.documentElement.style.setProperty('--resp-intensity', String(v));
    persistState();
  }
  function respOverride(v){
    const num = Number(v);
    if (!isNaN(num) && num>=4 && num<=60){ RESP = num; persistState(); }
  }
  function setSparkSmooth(v){
    sparkSmooth = Number(v)||0;
    drawSparkline();
    persistState();
  }

  function animateProgress(id, pct){
    const el = document.getElementById(id);
    if (!el) return;
    el.style.transition = 'width .35s ease';
    el.style.width = clamp(pct, 0, 100) + '%';
  }

  function closeModal(m) { const el = document.getElementById(m); if (el) el.classList.remove('active'); }

  if (heartVideo) {
    heartVideo.addEventListener('loadedmetadata', () => { setVideoRateFromHR(); });
    heartVideo.addEventListener('play', () => { bedStatusEl.textContent = (HR ?? bpm ?? 0) > 0 ? 'Running' : 'Stopped'; });
    heartVideo.addEventListener('pause', () => { bedStatusEl.textContent = 'Stopped'; });
  }

  // Inner heart navigation: persist analysis context
  function openInnerHeart(){
    try {
      const ctx = {
        name: LAST_ANALYSIS?.name || 'Patient',
        age: LAST_ANALYSIS?.age ?? null,
        dob: LAST_ANALYSIS?.dob ?? null,
        hr: Math.round(HR ?? bpm ?? 0),
        updatedAt: LAST_ANALYSIS?.updatedAt || new Date().toISOString()
      };
      localStorage.setItem(STORAGE_CONTEXT_KEY, JSON.stringify(ctx));
    } catch (e) {}
    location.href = 'inner-heart.html';
  }

  function exportMonitorPNG(){
    try{
      const canvas = document.createElement('canvas');
      canvas.width = monitorCanvas.width;
      canvas.height = monitorCanvas.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(monitorGrid, 0, 0);
      ctx.drawImage(monitorCanvas, 0, 0);
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a'); a.href = url; a.download = `monitor_${Date.now()}.png`; a.click();
      toast('<div><strong>PNG exported</strong></div>', 'success', 1200);
    }catch(e){
      toast('<div><strong>Export failed</strong></div>', 'error', 1200);
    }
  }

  // Persistence: save everything relevant
  function persistState(){
    const state = {
      theme: document.documentElement.getAttribute('data-theme') || 'dark',
      gridBright: parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-bright')) || 1.0,
      ecgIntensity: parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ecg-intensity')) || 1.0,
      respIntensity: parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--resp-intensity')) || 1.0,
      HR, bpm, RESP, mechScale,
      valvesMode, pacingOn, rhythmMode, arrhythmiaMode, showPressure,
      hrLocked, audioOn, sparkSmooth,
      lastAnalysis: LAST_ANALYSIS,
      hrHistory,
      displaySpO2: document.getElementById('displaySpO2')?.textContent || '0%'
    };
    try { localStorage.setItem(STORAGE_STATE_KEY, JSON.stringify(state)); } catch(e){}
  }

  function restoreState(){
    try {
      const raw = localStorage.getItem(STORAGE_STATE_KEY);
      if (!raw) {
        HR = 0; bpm = 0; RESP = 16;
        mechScale = 0;
        document.getElementById('displaySpO2').textContent = '0%';
        bedStatusEl.textContent = 'Stopped';
        updateHRBeacon('stopped');
        return;
      }
      const s = JSON.parse(raw);
      document.documentElement.setAttribute('data-theme', s.theme || 'dark');
      document.documentElement.style.setProperty('--grid-bright', String(s.gridBright ?? 1.0));
      document.documentElement.style.setProperty('--ecg-intensity', String(s.ecgIntensity ?? 1.0));
      document.documentElement.style.setProperty('--resp-intensity', String(s.respIntensity ?? 1.0));
      HR = s.HR ?? 0;
      bpm = s.bpm ?? 0;
      RESP = s.RESP ?? 16;
      mechScale = s.mechScale ?? 0;
      valvesMode = s.valvesMode ?? 'Auto';
      pacingOn = !!s.pacingOn;
      rhythmMode = s.rhythmMode ?? 'regular';
      arrhythmiaMode = s.arrhythmiaMode ?? null;
      showPressure = !!s.showPressure;
      hrLocked = !!s.hrLocked;
      audioOn = s.audioOn !== false;
      sparkSmooth = s.sparkSmooth ?? 3;
      LAST_ANALYSIS = s.lastAnalysis ?? null;
      document.getElementById('displaySpO2').textContent = s.displaySpO2 || '0%';
      updatePatientConditionPanel();
      // Restore HR history
      if (Array.isArray(s.hrHistory)) {
        hrHistory.length = 0;
        for (const p of s.hrHistory) { hrHistory.push(p); }
        drawSparkline();
        updateTrendLabel();
      }
      setVideoRateFromHR();
      updateHRBeacon(hrTier(HR ?? 0));
    } catch (e) {
      // Reset minimal state on error
      HR = 0; bpm = 0; RESP = 16; mechScale = 0;
      updateHRBeacon('stopped');
    }
  }
</script>

<
<script>
// ==================== FIR FILTER IMPLEMENTATION ====================
let originalECGData = [];
let filteredECGData = [];
let firCoefficients = [];
let firFilterActive = false;
let csvDataForFIR = null;
let imageDataForFIR = null;

function openFIRFilterModal() {
  document.getElementById('firFilterModal').classList.add('active');

  // Check if we have data from CSV or Image
  if (csvDataForFIR && csvDataForFIR.length > 0) {
    originalECGData = csvDataForFIR.slice();
    drawOriginalSignal();
    updateFIRFilter();
  } else if (imageDataForFIR && imageDataForFIR.length > 0) {
    originalECGData = imageDataForFIR.slice();
    drawOriginalSignal();
    updateFIRFilter();
  } else {
    // Initialize with zeros
    initializeFIRWithZeros();
  }
}

function initializeFIRWithZeros() {
  originalECGData = new Array(500).fill(0);
  filteredECGData = new Array(500).fill(0);
  firCoefficients = new Array(51).fill(0);

  drawOriginalSignal();
  drawFilteredSignal();
  drawFilterCoefficients();
  drawFrequencyResponse();

  document.getElementById('firFilterInfo').innerHTML = `
    <strong>Filter Type:</strong> BANDPASS<br>
    <strong>Cutoff Frequency:</strong> 0 Hz<br>
    <strong>Filter Order:</strong> 0 (0 taps)<br>
    <strong>Sample Rate:</strong> 0 Hz<br>
    <strong>Nyquist Frequency:</strong> 0 Hz<br>
    <strong>Group Delay:</strong> 0 samples<br>
    <strong>Status:</strong> ‚ö†Ô∏è Waiting for data upload (CSV or ECG Image)...
  `;
}

function generateSyntheticECG(samples) {
  const ecg = [];
  for (let i = 0; i < samples; i++) {
    const t = i / 100;
    let signal = 0;

    // P wave
    signal += 0.1 * Math.exp(-Math.pow((t % 1 - 0.2), 2) / 0.005);

    // QRS complex
    signal += 1.0 * Math.exp(-Math.pow((t % 1 - 0.4), 2) / 0.001);
    signal -= 0.3 * Math.exp(-Math.pow((t % 1 - 0.38), 2) / 0.0005);
    signal -= 0.3 * Math.exp(-Math.pow((t % 1 - 0.42), 2) / 0.0005);

    // T wave
    signal += 0.3 * Math.exp(-Math.pow((t % 1 - 0.65), 2) / 0.01);

    // Add noise
    signal += (Math.random() - 0.5) * 0.05;

    ecg.push(signal * 50);
  }
  return ecg;
}

function drawOriginalSignal() {
  const canvas = document.getElementById('firOriginalCanvas');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.offsetWidth * 2;
  const h = canvas.height = canvas.offsetHeight * 2;

  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, w, h);

  // Draw grid
  ctx.strokeStyle = 'rgba(0, 212, 255, 0.1)';
  ctx.lineWidth = 1;
  for (let i = 0; i < w; i += 40) {
    ctx.beginPath();
    ctx.moveTo(i, 0);
    ctx.lineTo(i, h);
    ctx.stroke();
  }
  for (let i = 0; i < h; i += 40) {
    ctx.beginPath();
    ctx.moveTo(0, i);
    ctx.lineTo(w, i);
    ctx.stroke();
  }

  // Draw zero line
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(0, h / 2);
  ctx.lineTo(w, h / 2);
  ctx.stroke();

  // Draw signal
  if (originalECGData.length === 0 || originalECGData.every(x => x === 0)) {
    return;
  }

  const max = Math.max(...originalECGData.map(Math.abs));
  if (max === 0) return;

  const scale = (h * 0.8) / (2 * max);
  const xStep = w / originalECGData.length;

  ctx.strokeStyle = '#00d4ff';
  ctx.lineWidth = 3;
  ctx.shadowColor = 'rgba(0, 212, 255, 0.5)';
  ctx.shadowBlur = 4;
  ctx.beginPath();

  originalECGData.forEach((val, i) => {
    const x = i * xStep;
    const y = h / 2 - val * scale;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();
  ctx.shadowBlur = 0;
}

function designFIRFilter() {
  const filterType = document.getElementById('firFilterType').value;
  const cutoff = parseFloat(document.getElementById('firCutoff').value);
  const order = parseInt(document.getElementById('firOrder').value);
  const sampleRate = parseFloat(document.getElementById('firSampleRate').value);

  const numTaps = order + 1;
  const coeffs = new Array(numTaps);
  const normalizedCutoff = cutoff / (sampleRate / 2);

  // Windowed sinc filter design
  for (let i = 0; i < numTaps; i++) {
    const n = i - order / 2;

    // Sinc function
    let h;
    if (n === 0) {
      h = 2 * normalizedCutoff;
    } else {
      h = Math.sin(2 * Math.PI * normalizedCutoff * n) / (Math.PI * n);
    }

    // Hamming window
    const window = 0.54 - 0.46 * Math.cos(2 * Math.PI * i / order);
    coeffs[i] = h * window;
  }

  // Normalize
  const sum = coeffs.reduce((a, b) => a + Math.abs(b), 0);
  for (let i = 0; i < numTaps; i++) {
    coeffs[i] /= sum;
  }

  // High-pass transformation
  if (filterType === 'highpass') {
    for (let i = 0; i < numTaps; i++) {
      coeffs[i] *= Math.pow(-1, i);
    }
  }

  return coeffs;
}

function applyFIRFilterToSignal(signal, coeffs) {
  const filtered = [];
  const n = signal.length;
  const m = coeffs.length;

  for (let i = 0; i < n; i++) {
    let sum = 0;
    for (let j = 0; j < m; j++) {
      const idx = i - j;
      if (idx >= 0) {
        sum += signal[idx] * coeffs[j];
      }
    }
    filtered.push(sum);
  }

  return filtered;
}

function updateFIRFilter() {
  firCoefficients = designFIRFilter();
  drawFilterCoefficients();
  drawFrequencyResponse();
  updateFilterInfo();
}

function applyFIRFilter() {
  if (originalECGData.length === 0 || originalECGData.every(x => x === 0)) {
    toast('‚ö†Ô∏è No ECG data available. Upload CSV or ECG Image data first.', 'info');
    return;
  }

  firFilterActive = true;
  filteredECGData = applyFIRFilterToSignal(originalECGData, firCoefficients);
  drawFilteredSignal();
  toast('‚úÖ FIR filter applied successfully!', 'success');
}

function drawFilteredSignal() {
  const canvas = document.getElementById('firFilteredCanvas');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.offsetWidth * 2;
  const h = canvas.height = canvas.offsetHeight * 2;

  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, w, h);

  // Draw grid
  ctx.strokeStyle = 'rgba(6, 255, 165, 0.1)';
  ctx.lineWidth = 1;
  for (let i = 0; i < w; i += 40) {
    ctx.beginPath();
    ctx.moveTo(i, 0);
    ctx.lineTo(i, h);
    ctx.stroke();
  }
  for (let i = 0; i < h; i += 40) {
    ctx.beginPath();
    ctx.moveTo(0, i);
    ctx.lineTo(w, i);
    ctx.stroke();
  }

  // Draw zero line
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(0, h / 2);
  ctx.lineTo(w, h / 2);
  ctx.stroke();

  // Draw signal
  if (filteredECGData.length === 0 || filteredECGData.every(x => x === 0)) {
    return;
  }

  const max = Math.max(...filteredECGData.map(Math.abs));
  if (max === 0) return;

  const scale = (h * 0.8) / (2 * max);
  const xStep = w / filteredECGData.length;

  ctx.strokeStyle = '#06ffa5';
  ctx.lineWidth = 3;
  ctx.shadowColor = 'rgba(6, 255, 165, 0.5)';
  ctx.shadowBlur = 4;
  ctx.beginPath();

  filteredECGData.forEach((val, i) => {
    const x = i * xStep;
    const y = h / 2 - val * scale;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();
  ctx.shadowBlur = 0;
}

function drawFrequencyResponse() {
  const canvas = document.getElementById('firFrequencyCanvas');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.offsetWidth * 2;
  const h = canvas.height = canvas.offsetHeight * 2;

  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, w, h);

  // Draw grid
  ctx.strokeStyle = 'rgba(255, 215, 0, 0.1)';
  ctx.lineWidth = 1;
  for (let i = 0; i < w; i += 40) {
    ctx.beginPath();
    ctx.moveTo(i, 0);
    ctx.lineTo(i, h);
    ctx.stroke();
  }
  for (let i = 0; i < h; i += 40) {
    ctx.beginPath();
    ctx.moveTo(0, i);
    ctx.lineTo(w, i);
    ctx.stroke();
  }

  if (firCoefficients.length === 0 || firCoefficients.every(c => c === 0)) {
    return;
  }

  // Compute frequency response
  const numPoints = 512;
  const response = [];

  for (let k = 0; k < numPoints / 2; k++) {
    const omega = (2 * Math.PI * k) / numPoints;
    let real = 0, imag = 0;

    firCoefficients.forEach((coeff, n) => {
      real += coeff * Math.cos(omega * n);
      imag -= coeff * Math.sin(omega * n);
    });

    const magnitude = Math.sqrt(real * real + imag * imag);
    response.push(20 * Math.log10(magnitude + 1e-10));
  }

  // Draw response
  const xStep = w / response.length;
  const yScale = h / 60;

  ctx.strokeStyle = '#ffd700';
  ctx.lineWidth = 3;
  ctx.shadowColor = 'rgba(255, 215, 0, 0.5)';
  ctx.shadowBlur = 4;
  ctx.beginPath();

  response.forEach((db, i) => {
    const x = i * xStep;
    const y = h - (db + 60) * yScale;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();
  ctx.shadowBlur = 0;

  // Draw 0dB line
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
  ctx.lineWidth = 2;
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.moveTo(0, h - 60 * yScale);
  ctx.lineTo(w, h - 60 * yScale);
  ctx.stroke();
  ctx.setLineDash([]);
}

function drawFilterCoefficients() {
  const canvas = document.getElementById('firCoeffCanvas');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.offsetWidth * 2;
  const h = canvas.height = canvas.offsetHeight * 2;

  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, w, h);

  // Draw grid
  ctx.strokeStyle = 'rgba(255, 107, 157, 0.08)';
  ctx.lineWidth = 1;
  for (let i = 0; i < w; i += 40) {
    ctx.beginPath();
    ctx.moveTo(i, 0);
    ctx.lineTo(i, h);
    ctx.stroke();
  }
  for (let i = 0; i < h; i += 40) {
    ctx.beginPath();
    ctx.moveTo(0, i);
    ctx.lineTo(w, i);
    ctx.stroke();
  }

  // Draw zero line
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
  ctx.lineWidth = 1.5;
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.moveTo(0, h / 2);
  ctx.lineTo(w, h / 2);
  ctx.stroke();
  ctx.setLineDash([]);

  if (firCoefficients.length === 0 || firCoefficients.every(c => c === 0)) {
    return;
  }

  const max = Math.max(...firCoefficients.map(Math.abs));
  if (max === 0) return;

  // Calculate proper scaling with padding
  const scale = (h * 0.85) / (2 * max);
  const xStep = w / (firCoefficients.length + 1);
  const xOffset = xStep / 2;

  // Draw stems and markers with accurate positioning
  firCoefficients.forEach((coeff, i) => {
    const x = xOffset + i * xStep;
    const y = h / 2 - coeff * scale;

    // Stem line
    ctx.strokeStyle = coeff >= 0 ? '#ff6b9d' : '#ff4757';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x, h / 2);
    ctx.lineTo(x, y);
    ctx.stroke();

    // Marker circle with glow
    ctx.fillStyle = coeff >= 0 ? '#ff6b9d' : '#ff4757';
    ctx.shadowColor = coeff >= 0 ? 'rgba(255, 107, 157, 0.6)' : 'rgba(255, 71, 87, 0.6)';
    ctx.shadowBlur = 8;
    ctx.beginPath();
    ctx.arc(x, y, 5, 0, 2 * Math.PI);
    ctx.fill();
    ctx.shadowBlur = 0;
  });

  // Draw value labels for key coefficients
  ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
  ctx.font = 'bold 10px monospace';
  ctx.textAlign = 'center';

  for (let i = 0; i < firCoefficients.length; i += 10) {
    const x = xOffset + i * xStep;
    const coeff = firCoefficients[i];
    const y = h / 2 - coeff * scale;
    const label = coeff.toFixed(4);

    if (coeff > 0) {
      ctx.fillText(label, x, y - 12);
    } else {
      ctx.fillText(label, x, y + 22);
    }
  }
}

function updateFilterInfo() {
  const filterType = document.getElementById('firFilterType').value;
  const cutoff = document.getElementById('firCutoff').value;
  const order = document.getElementById('firOrder').value;
  const sampleRate = document.getElementById('firSampleRate').value;

  const info = `
    <strong>Filter Type:</strong> ${filterType.toUpperCase()}<br>
    <strong>Cutoff Frequency:</strong> ${cutoff} Hz<br>
    <strong>Filter Order:</strong> ${order} (${parseInt(order) + 1} taps)<br>
    <strong>Sample Rate:</strong> ${sampleRate} Hz<br>
    <strong>Nyquist Frequency:</strong> ${parseFloat(sampleRate) / 2} Hz<br>
    <strong>Group Delay:</strong> ${parseInt(order) / 2} samples
  `;

  document.getElementById('firFilterInfo').innerHTML = info;
}

function resetFIRFilter() {
  document.getElementById('firFilterType').value = 'bandpass';
  document.getElementById('firCutoff').value = '40';
  document.getElementById('firOrder').value = '50';
  document.getElementById('firSampleRate').value = '500';

  filteredECGData = [];
  firFilterActive = false;
  updateFIRFilter();

  const canvas = document.getElementById('firFilteredCanvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  toast('üîÑ Filter reset to default values', 'info');
}

function exportFilteredSignal() {
  if (filteredECGData.length === 0 || filteredECGData.every(x => x === 0)) {
    toast('‚ö†Ô∏è No filtered data to export. Apply filter first.', 'info');
    return;
  }

  let csv = 'Sample,Original,Filtered\n';
  for (let i = 0; i < originalECGData.length; i++) {
    csv += `${i},${originalECGData[i]},${filteredECGData[i] || ''}\n`;
  }

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'filtered_ecg_signal.csv';
  a.click();

  toast('‚úÖ Filtered signal exported successfully!', 'success');
}
</script>



</body>
</html>