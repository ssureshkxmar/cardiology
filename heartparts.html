<!DOCTYPE html>
<html lang="en">
<head>
    <title>Heart Visualization - 3D Anatomical Viewer</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <!-- Shader -->
    <script src="./shader.js"></script>

    <!-- Menu -->
    <script src="./menuStyle.js"></script>

    <!-- Data -->
    <script src="./data/Postnatal_anatomical_structure/Postnatal_anatomical_structure.js"></script>

    <!-- Code -->
    <script src="./findWikipediaInfos.js"></script>

    <!-- Libraries -->
    <script src="./libraries/jquery-3.5.1.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>

    <style>
        /* BLACK GLASSMORPHISM UI STYLING */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            --glass-hover: rgba(255, 255, 255, 0.08);
            --primary-gradient: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            --accent-gradient: linear-gradient(135deg, #ff006e 0%, #8338ec 100%);
            --success-gradient: linear-gradient(135deg, #06ffa5 0%, #00d4ff 100%);
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            --backdrop-blur: blur(20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #000000;
            color: var(--text-primary);
            position: relative;
        }

        /* Full Black Background - No gradients */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            z-index: 0;
            pointer-events: none;
        }

        /* Government Header */
        .gov-header {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border-bottom: 1px solid var(--glass-border);
            padding: 10px 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .gov-header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .gov-emblem {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            position: relative;
            overflow: hidden;
        }

        .gov-emblem img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(1.1) contrast(1.2) drop-shadow(0 0 10px rgba(218, 165, 32, 0.6));
            mix-blend-mode: screen;
        }

        .gov-text {
            display: flex;
            flex-direction: column;
        }

        .gov-text span:first-child {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .gov-text span:last-child {
            font-size: 1rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .gov-right {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* App Header Band */
        .app-header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border-bottom: 1px solid var(--glass-border);
            padding: 20px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .app-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            z-index: 1;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-button:hover {
            background: rgba(0, 100, 150, 0.3);
            transform: translateX(-4px);
            border-color: rgba(0, 212, 255, 0.5);
        }

        .app-header-content {
            display: flex;
            flex-direction: column;
        }

        .app-title {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.01em;
            background: linear-gradient(135deg, #fff 0%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .app-header-right {
            text-align: right;
            font-size: 0.85rem;
            color: var(--text-secondary);
            position: relative;
            z-index: 1;
        }

        .app-header-right div {
            margin-bottom: 4px;
        }

        .app-header-right strong {
            color: #00d4ff;
            font-weight: 700;
        }

        /* Controls Panel */
        .controls-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            width: 320px;
            z-index: 100;
            box-shadow: var(--glass-shadow);
        }

        .controls-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 10px;
            display: block;
            font-weight: 600;
        }

        select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            font-size: 0.9rem;
            background: rgba(0, 212, 255, 0.05);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: 600;
        }

        select:hover {
            border-color: rgba(0, 212, 255, 0.5);
            background: rgba(0, 212, 255, 0.08);
        }

        select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
            background: rgba(0, 212, 255, 0.1);
        }

        /* Canvas Container - FULL BLACK */
        #glFullscreen {
            width: 100%;
            height: calc(100vh - 140px);
            position: relative;
            background: #000000;
        }

        #heartCanvas {
            width: 100%;
            height: 100%;
            display: block;
            background: #000000;
        }

        /* Structure Name Tooltip */
        .structure_name {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            visibility: hidden;
        }

        /* Wikipedia Info Box */
        .wikipediaInfo {
            position: absolute;
            bottom: 80px;
            left: 20px;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--glass-shadow);
            z-index: 90;
            max-height: 350px;
            overflow-y: auto;
        }

        .wikipediaInfo::-webkit-scrollbar {
            width: 6px;
        }

        .wikipediaInfo::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .wikipediaInfo::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 3px;
        }

        .wikipediaInfo h3 {
            font-size: 1.15rem;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .wikipediaInfo p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 12px;
        }

        .wikipediaInfo a {
            color: #00d4ff;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .wikipediaInfo a:hover {
            color: #06ffa5;
            text-decoration: underline;
        }

        .wiki-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 0, 110, 0.2);
            border: 1px solid rgba(255, 0, 110, 0.4);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #ff006e;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .wiki-close:hover {
            background: rgba(255, 0, 110, 0.3);
            transform: scale(1.1);
        }

        /* Info Badge */
        .info-badge {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            box-shadow: var(--glass-shadow);
            max-width: 400px;
            line-height: 1.6;
        }

        .info-badge strong {
            color: #00d4ff;
            font-weight: 700;
        }

        /* Responsive */
        @media (max-width: 980px) {
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .app-header-right {
                text-align: left;
            }

            .app-header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .controls-panel {
                width: calc(100% - 40px);
                right: 20px;
                top: 20px;
            }

            .gov-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 12px 16px;
            }

            .gov-right {
                display: none;
            }

            .info-badge {
                font-size: 0.75rem;
                padding: 12px 14px;
                max-width: calc(100% - 40px);
            }

            .wikipediaInfo {
                max-width: calc(100% - 40px);
                bottom: 60px;
            }
        }
    </style>
</head>

<body>

<!-- Government Header -->
<div class="gov-header">
    <div class="gov-header-left">
        <div class="gov-emblem">
            <img src="image.jpg" alt="Student of India Emblem">
        </div>
        <div class="gov-text">
            <span>Student of India</span>
            <span>Ministry of Health & Family Welfare</span>
        </div>
    </div>
    <div class="gov-right">Cardiology AI Pilot ‚Äì Internal Use Only</div>
</div>

<!-- App Header Band -->
<div class="app-header">
    <div class="app-header-left">
        <a href="heart.html" class="back-button" onclick="goBack(event)">
            <span>‚Üê</span>
            <span>Back</span>
        </a>
        <div class="app-header-content">
            <div class="app-title">ü´Ä Heart 3D Anatomical Visualization</div>
            <div class="app-subtitle">Interactive 3D model with detailed anatomical structures</div>
        </div>
    </div>
    <div class="app-header-right">
        <div>Environment: <strong>Research Mode</strong></div>
        <div>Viewer: Three.js WebGL</div>
    </div>
</div>

<!-- Canvas Container -->
<div id="glFullscreen">
    <canvas id="heartCanvas"></canvas>

    <!-- Info Badge -->
    <div class="info-badge">
        <strong>üí° How to Use:</strong> Click & drag to rotate ‚Ä¢ Scroll to zoom ‚Ä¢ Hover over structures for labels ‚Ä¢ Select a structure and language to view Wikipedia info
    </div>
</div>

<!-- Modern Controls Panel -->
<div class="controls-panel">
    <div class="controls-title">
        ‚öôÔ∏è Visualization Controls
    </div>

    <div class="control-group">
        <label class="control-label" for="Organs">ü´Ä Select Anatomical Structure</label>
        <select id="Organs">
            <option value="Select part of organ:">Select part of organ:</option>
            <option value="Show all">Show all</option>
        </select>
    </div>

    <div class="control-group">
        <label class="control-label" for="languageSelector">üåê Wikipedia Language</label>
        <select id="languageSelector">
            <option value="none">none</option>
        </select>
    </div>
</div>

<!-- Structure Name Tooltip -->
<div class="structure_name"></div>

<script>
    // Back button navigation fix
    function goBack(event) {
        event.preventDefault();
        window.location.href = 'heart.html';
    }

    $(document).bind('mousemove', function (e) {
        $('.structure_name').css({
            left: e.pageX + 20,
            top: e.pageY + 10
        });
    });
</script>

<script type="module">
    'use strict';

    import * as THREE from './libraries/threejs/build/three.module.js';
    import {MeshPhongMaterial} from "./libraries/threejs/src/materials/MeshPhongMaterial.js";
    import {TrackballControls} from "./libraries/threejs/examples/jsm/controls/TrackballControls.js";
    import {OBJLoader2Parallel} from "./libraries/threejs/examples/jsm/loaders/OBJLoader2Parallel.js";
    import {EffectComposer} from './libraries/threejs/examples/jsm/postprocessing/EffectComposer.js';
    import {RenderPass} from './libraries/threejs/examples/jsm/postprocessing/RenderPass.js';
    import {ShaderPass} from './libraries/threejs/examples/jsm/postprocessing/ShaderPass.js';
    import {UnrealBloomPass} from './libraries/threejs/examples/jsm/postprocessing/UnrealBloomPass.js';

    let vertexShaderXX = [
        "varying vec2 vUv; ",
        "void main() { ",
        "   vUv = uv; ",
        "   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 ); ",
        "} "
    ].join('\n');

    let fragmentShaderXX = [
        "uniform sampler2D baseTexture; ",
        "uniform sampler2D bloomTexture; ",
        "varying vec2 vUv; ",
        "void main() { ",
        "   gl_FragColor = ( texture2D( baseTexture, vUv ) + vec4( 1.0 ) * texture2D( bloomTexture, vUv ) ); ",
        "} ",
    ].join('\n');

    let DEBUG = false;
    let ENTIRE_SCENE = 0;
    let BLOOM_SCENE = 1;
    var showFurtherInformation = true;
    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        showFurtherInformation = false;
    }

    let bloomLayer = new THREE.Layers();
    bloomLayer.set(BLOOM_SCENE);
    let materials = {};
    let darkMaterial = new THREE.MeshBasicMaterial({color: "black"});
    let mouse = new THREE.Vector2(0, 0);

    function getSelectedLanguage() {
        let sel = document.getElementById("languageSelector");
        if (!sel || sel.selectedIndex < 0) return "none";
        if (sel.options[sel.selectedIndex].text === "none") {
            return "none"
        } else {
            return sel.options[sel.selectedIndex].text;
        }
    }

    const anatomicalStructuresOBJLoader2 = function (elementToBindTo) {

        this.params = {
            exposure: 1,
            bloomStrength: 1.3,
            bloomThreshold: 0,
            bloomRadius: 0
        };
        this.INTERSECTED = null;
        this.raycaster = new THREE.Raycaster();

        this.finalComposer = null;
        this.renderer = null;
        this.bloomComposer = null;
        this.canvas = elementToBindTo;
        this.aspectRatio = 1;
        this.recalculateAspectRatio();

        this.scene = null;
        this.cameraDefaults = {
            posCamera: new THREE.Vector3(-70, 120, -1050),
            posCameraTarget: new THREE.Vector3(-70, 120, -1250),
            near: 0.1,
            far: 10000,
            fov: 45
        };
        this.camera = null;
        this.cameraTarget = this.cameraDefaults.posCameraTarget;

        this.controls = null;

        this.flatShading = false;
        this.useJsmWorker = false;
        this.loadCount = 6;

        this.pivot = null;

        this.spheresIndex = 0;
        this.spheres = [];
        this.toggle = 0;
    };

    anatomicalStructuresOBJLoader2.prototype = {
        constructor: anatomicalStructuresOBJLoader2,

        initGL: function () {
            this.renderer = new THREE.WebGLRenderer({
                canvas: this.canvas,
                antialias: true,
                autoClear: true
            });
            this.renderer.setPixelRatio(window.devicePixelRatio);
            this.renderer.setClearColor(0x000000); // Pure black background
            this.renderer.setSize(this.canvas.clientWidth, this.canvas.clientHeight);

            this.scene = new THREE.Scene();
            this.scene.traverse(this.disposeMaterial);

            this.camera = new THREE.PerspectiveCamera(this.cameraDefaults.fov, this.aspectRatio, this.cameraDefaults.near, this.cameraDefaults.far);
            this.resetCamera();
            this.controls = new TrackballControls(this.camera, this.renderer.domElement);

            // Enhanced lighting for better visibility on black background
            let ambientLight = new THREE.AmbientLight(0x808080, 1.2);
            let directionalLight1 = new THREE.DirectionalLight(0xffffff, 1.5);
            let directionalLight2 = new THREE.DirectionalLight(0xffffff, 1.5);

            directionalLight1.position.set(-100, -50, 100);
            directionalLight2.position.set(100, 50, -100);

            this.scene.add(ambientLight);
            this.scene.add(directionalLight1);
            this.scene.add(directionalLight2);

            this.pivot = new THREE.Object3D();
            this.pivot.name = 'Pivot';
            this.scene.add(this.pivot);

            let renderPass = new RenderPass(this.scene, this.camera);

            let bloomPass = new UnrealBloomPass(new THREE.Vector2(this.canvas.innerWidth, this.canvas.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = this.params.bloomThreshold;
            bloomPass.strength = this.params.bloomStrength;
            bloomPass.radius = this.params.bloomRadius;

            this.bloomComposer = new EffectComposer(this.renderer);
            this.bloomComposer.renderToScreen = false;
            this.bloomComposer.addPass(renderPass);
            this.bloomComposer.addPass(bloomPass);
            let finalPass = new ShaderPass(
                new THREE.ShaderMaterial({
                    uniforms: {
                        baseTexture: {value: null},
                        bloomTexture: {value: this.bloomComposer.renderTarget2.texture}
                    },
                    vertexShader: vertexShaderXX,
                    fragmentShader: fragmentShaderXX,
                    defines: {}
                }), "baseTexture"
            );
            finalPass.needsSwap = true;

            this.finalComposer = new EffectComposer(this.renderer);
            this.finalComposer.addPass(renderPass);
            this.finalComposer.addPass(finalPass);
        },

        useLoadParallel: function (modelInfos, ID, organName) {
            let modelName = modelInfos.Filename;
            const testFolder = './data/Postnatal_anatomical_structure/';
            this._reportProgress({detail: {text: 'Loading: ' + organName}});

            let local = new THREE.Object3D();
            local.name = 'Pivot_WaltHead';
            local.position.set(-70, 120, -1250);
            let scale = 1.0;
            local.scale.set(scale, scale, scale);
            this.pivot.add(local);

            let objLoader2Parallel = new OBJLoader2Parallel().setModelName(modelName)
                .setJsmWorker(this.useJsmWorker, new URL(OBJLoader2Parallel.DEFAULT_JSM_WORKER_PATH, window.location.href));

            let scope = this;

            let material = new MeshPhongMaterial({color: modelInfos.Class, opacity: 1.0, transparent: true});

            function callbackOnLoad(object3d, message) {
                object3d.traverse(function (child) {
                    if (child instanceof THREE.Mesh) {
                        child.material = material;
                        child.userData = {name: organName};
                    }
                    object3d.userData = {name: organName};
                });
                local.add(object3d);

                scope._reportProgress({detail: {text: 'Loading of ' + modelName + ' completed: ' + message}});
                scope.finalize();
            }

            objLoader2Parallel.load(testFolder + modelName, callbackOnLoad);
            partsModels[ID] = local;
        },

        finalize: function () {
            this.loadCount--;
            if (this.loadCount === 0) {
                this._reportProgress({detail: {text: ''}});
            }
        },

        _reportProgress: function (event) {
            let output = '';
            if (event.detail !== null && event.detail !== undefined && event.detail.text) {
                output = event.detail.text;
            }
            if (DEBUG) {
                console.log('Progress: ' + output);
            }
        },

        resizeDisplayGL: function () {
            if (DEBUG) {
                console.log("resizeDisplayGL")
            }
            this.controls.handleResize();
            this.recalculateAspectRatio();
            this.updateCamera();
            this.renderer.setSize(this.canvas.clientWidth, this.canvas.clientHeight, false);
            this.bloomComposer.setSize(this.canvas.clientWidth, this.canvas.clientHeight);
            this.finalComposer.setSize(this.canvas.clientWidth, this.canvas.clientHeight);
        },

        recalculateAspectRatio: function () {
            this.aspectRatio = this.canvas.clientWidth / this.canvas.clientHeight;
        },

        resetCamera: function () {
            this.camera.position.copy(this.cameraDefaults.posCamera);
            this.cameraTarget.copy(this.cameraDefaults.posCameraTarget);
            this.updateCamera();
        },

        updateCamera: function () {
            this.camera.aspect = this.aspectRatio;
            this.camera.lookAt(this.cameraTarget);
            this.camera.updateProjectionMatrix();
        },

        renderBloom: function () {
            this.scene.traverse(this.darkenNonBloomed);
            this.bloomComposer.render();
            this.scene.traverse(this.restoreMaterial);
        },

        darkenNonBloomed: function (obj) {
            if (obj.isMesh && bloomLayer.test(obj.layers) === false) {
                materials[obj.uuid] = obj.material;
                obj.material = darkMaterial;
            }
        },

        restoreMaterial: function (obj) {
            if (materials[obj.uuid]) {
                obj.material = materials[obj.uuid];
                delete materials[obj.uuid];
            }
        },

        disposeMaterial: function (obj) {
            if (obj.material) {
                obj.material.dispose();
            }
        },

        render: function () {
            if (!this.renderer.autoClear) this.renderer.clear();
            this.controls.update();
            this.renderBloom();
            this.finalComposer.render();

            if (showFurtherInformation) {
                this.raycaster.setFromCamera(mouse, this.camera);
                let intersects = this.raycaster.intersectObjects(this.pivot.children, true);
                let hoverInfo = $('.structure_name');
                if (intersects.length > 0) {
                    let nearestObj = this.getClosestVisibleObject(intersects)
                    if (nearestObj !== null) {
                        if (this.INTERSECTED !== nearestObj) {
                            this.INTERSECTED = nearestObj;
                            hoverInfo.html(this.INTERSECTED.userData.name);
                            hoverInfo.css('visibility', 'visible');
                        }
                    } else {
                        hoverInfo.css('visibility', 'hidden');
                        this.INTERSECTED = null;
                    }
                } else {
                    hoverInfo.css('visibility', 'hidden');
                    this.INTERSECTED = null;
                }
            }
        },

        executeLoading: function () {
            let menu = document.getElementById("Organs");
            for (let currentObject in Postnatal_anatomical_structure) {
                let organName = Postnatal_anatomical_structure[currentObject].Filename.replace('.obj', '').split("_");
                this.useLoadParallel(Postnatal_anatomical_structure[currentObject], organName[0], organName[organName.length - 1]);
                let currentName = organName[organName.length - 1];
                if (!this.arrayContainsString(nameAndID, currentName)) {
                    menu.add(new Option(currentName, currentName), undefined);
                }
                nameAndID[organName[0]] = currentName;
            }
            sortList();
        },

        arrayContainsString: function (myArray, value) {
            for (let i in myArray) {
                if (myArray[i] === value) {
                    return true;
                }
            }
            return false;
        },

        onDocumentMouseMove: function (event) {
            event.preventDefault();
            let menuHeight = 140;
            mouse.x = (event.clientX / this.canvas.clientWidth) * 2 - 1;
            mouse.y = -((event.clientY - menuHeight) / this.canvas.clientHeight) * 2 + 1;
        },

        getClosestVisibleObject: function (intersects) {
            for (let i in intersects) {
                let object = intersects[i].object;
                if (object.visible) {
                    return object;
                }
            }
            return null;
        },

        onDocumentMouseClick_object: function (event) {
            event.preventDefault();
            this.raycaster.setFromCamera(mouse, this.camera);
            let intersects = this.raycaster.intersectObjects(this.pivot.children, true);

            if (intersects.length > 0) {
                let object = this.getClosestVisibleObject(intersects);
                if (object !== null) {
                    object.visible = false;
                }
                this.render();
            }
        }
    };

    let partsModels = [];
    let nameAndID = [];

    function onDocumentMouseClick(currentName) {
        app.onDocumentMouseClick_object(currentName);
    }

    function onDocumentMouseMove(event) {
        app.onDocumentMouseMove(event);
    }

    let oldName = ""

    function emphasizeOrgan(currentName) {
        changeAllMaterial(1.0);
        for (let ID in nameAndID) {
            if (nameAndID[ID] === currentName) {
                partsModels[ID].children[0].children[0].layers.toggle(BLOOM_SCENE);
            } else if (nameAndID[ID] === oldName) {
                partsModels[ID].children[0].children[0].layers.toggle(BLOOM_SCENE);
            }
        }
        oldName = currentName;
    }

    function changeAllMaterial(opacity) {
        let i = 0;
        for (let currentID in nameAndID) {
            i = i + 1;
            partsModels[currentID].children[0].children[0].visible = true;
            changeMaterial(currentID, opacity)
        }
    }

    function changeMaterial(ID, opacity) {
        partsModels[ID].layers.toggle(ENTIRE_SCENE);
        let materialColor = partsModels[ID].children[0].children[0].material.color;

        partsModels[ID].children[0].children[0].material = new MeshPhongMaterial({
            color: materialColor,
            opacity: opacity,
            transparent: true,
            depthTest: true
        });
        partsModels[ID].children[0].children[0].geometry.uvsNeedUpdate = true;
        partsModels[ID].needsUpdate = true;
    }

    function changeMaterialOfObject(object, opacity) {
        let materialColor = object.material.color;

        object.material = new MeshPhongMaterial({
            color: materialColor,
            opacity: opacity,
            transparent: true,
            depthTest: true
        });
        object.geometry.uvsNeedUpdate = true;
        object.needsUpdate = true;
    }

    function removeDivByID(divId) {
        $(divId).remove();
    }

    let element_selector = document.getElementById("Organs");
    let language_selector = document.getElementById("languageSelector");

    // Populate language selector
    if (typeof Postnatal_anatomical_structure !== 'undefined' && Postnatal_anatomical_structure.length > 0) {
        for (let i in Postnatal_anatomical_structure[0].wikipediaInfos) {
            language_selector.add(new Option(i, i), undefined);
        }
    }

    function sortList() {
        let cl = document.getElementById("Organs");
        let clTexts = [];
        for (let i = 2; i < cl.length; i++) {
            clTexts[i - 2] =
                cl.options[i].text.toUpperCase() + "," +
                cl.options[i].text + "," +
                cl.options[i].value + "," +
                cl.options[i].selected;
        }
        clTexts.sort();
        for (let i = 2; i < cl.length; i++) {
            let parts = clTexts[i - 2].split(',');
            cl.options[i].text = parts[1];
            cl.options[i].value = parts[2];
            cl.options[i].selected = parts[3] === "true";
        }
    }

    function updateValue(e) {
        if (e.target.value === "Select part of organ:" || e.target.value === "Show all") {
            resetMaterial();
            removeDivByID(".wikipediaInfo")
        } else {
            emphasizeOrgan(e.target.value);
            updateWikipedia()
        }
    }

    function updateWikipedia() {
        let currentLanguage = getSelectedLanguage();
        let selO = document.getElementById("Organs");
        let selOText = selO.options[selO.selectedIndex].text;

        console.log("updateWikipedia called:", currentLanguage, selOText);

        if (currentLanguage === "none" || selOText === "Select part of organ:" || selOText === "Show all") {
            removeDivByID(".wikipediaInfo")
        } else {
            // Call loadWikipediaPreview with proper parameters
            if (typeof loadWikipediaPreview === 'function') {
                loadWikipediaPreview(selOText, currentLanguage);
            } else {
                console.error("loadWikipediaPreview function not found");
            }
        }
    }

    element_selector.addEventListener('change', updateValue);
    language_selector.addEventListener('change', updateWikipedia);

    function resetMaterial() {
        emphasizeOrgan("")
        changeAllMaterial(1.0)
    }

    let app = new anatomicalStructuresOBJLoader2(document.getElementById('heartCanvas'));

    function resizeWindow() {
        app.resizeDisplayGL();
    }

    function render() {
        requestAnimationFrame(render);
        app.render();
    }

    window.addEventListener('resize', resizeWindow, false);
    window.addEventListener('click', onDocumentMouseClick, false);

    document.addEventListener('mousemove', onDocumentMouseMove, false);
    if (DEBUG) {
        console.log('Starting initialisation phase...');
    }
    app.initGL();
    app.resizeDisplayGL();

    render();
    app.executeLoading();

</script>
</body>
</html>
